<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Crooks & Castles ‚Äî Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0a0a;--card:#111;--line:#222;--muted:#9ca3af;--brand:#22c55e}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  .tabs{display:flex;gap:8px;margin:8px 0 16px}
  .tab{padding:8px 12px;border:1px solid #333;border-radius:10px;background:#101010;cursor:pointer}
  .tab.active{border-color:var(--brand)}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
  .item{background:#151515;border:1px solid var(--line);border-radius:10px;padding:12px}
  h1{font-size:20px;margin:0 0 6px} h2{font-size:16px;margin:0 0 10px}
  .muted{color:var(--muted);font-size:12px} .badge{background:var(--brand);color:#000;padding:2px 6px;border-radius:6px}
  .btn{display:inline-block;background:#1d1d1d;border:1px solid #404040;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;cursor:pointer}
  .btn.primary{background:var(--brand);color:#000;border-color:#198c44}
  .row-slim{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .upload{border:1px dashed #3a3a3a;border-radius:10px;padding:12px;text-align:center}
  input[type=file]{color:#cbd5e1}
  hr{border:0;border-top:1px solid var(--line);margin:12px 0}
</style>
<script src="crooks_enhancements.js"></script>
<script src="google_drive_integration.js"></script>
</head>
<body>
<div class="wrap">
  <h1>üè∞ Crooks & Castles ‚Äî Command Center <span class="badge">Live</span></h1>
  <div class="muted">This UI calls your backend APIs: /api/calendar/7day ‚Ä¢ /api/assets ‚Ä¢ /api/deliverables</div>

  <div class="card">
    <div class="tabs">
      <div id="tab-cal" class="tab active" onclick="showTab('cal')">Calendar Planning</div>
      <div id="tab-assets" class="tab" onclick="showTab('assets')">Asset Library</div>
      <div id="tab-agency" class="tab" onclick="showTab('agency')">Agency Tracking</div>
      <div id="tab-raw" class="tab" onclick="showTab('raw')">Raw API</div>
    </div>

    <!-- Calendar -->
    <section id="view-cal">
      <div class="row-slim" style="margin-bottom:10px">
        <button class="btn" onclick="loadCal('7day')">7-Day Tactical</button>
        <button class="btn" onclick="loadCal('30day')">30-Day Strategic</button>
        <button class="btn" onclick="loadCal('60day')">60-Day Opportunities</button>
        <button class="btn" onclick="loadCal('90day')">90-Day+ Vision</button>
      </div>
      <div id="cal" class="grid"></div>
    </section>

    <!-- Assets -->
    <section id="view-assets" style="display:none">
      <div class="upload">
        <div class="row-slim" style="justify-content:center;gap:10px">
          <input id="assetFiles" type="file" multiple accept="image/*,video/*"/>
          <button class="btn primary" onclick="uploadAssets()">Upload</button>
        </div>
        <div class="muted" style="margin-top:6px">Images & videos supported. Requires /api/upload-assets.</div>
      </div>
      <div id="assets" class="grid" style="margin-top:10px"></div>
    </section>

    <!-- Agency -->
    <section id="view-agency" style="display:none">
      <div class="upload">
        <div class="row-slim" style="justify-content:center;gap:10px">
          <input id="reportFile" type="file" accept=".csv,.xlsx,.json"/>
          <button class="btn primary" onclick="uploadReport()">Upload Performance Report</button>
        </div>
        <div class="muted" style="margin-top:6px">CSV/XLSX/JSON. Requires /api/upload-performance-report.</div>
      </div>
      <div id="agency" class="grid" style="margin-top:10px"></div>
      <div id="insights" class="item" style="display:none;margin-top:10px"></div>
    </section>

    <!-- Raw -->
    <section id="view-raw" style="display:none">
      <div class="row-slim" style="gap:8px;margin-bottom:8px">
        <a class="btn" href="/healthz" target="_blank">/healthz</a>
        <a class="btn" href="/api/calendar/7day" target="_blank">/api/calendar/7day</a>
        <a class="btn" href="/api/assets" target="_blank">/api/assets</a>
        <a class="btn" href="/api/deliverables" target="_blank">/api/deliverables</a>
      </div>
      <div class="muted">Open in a new tab to view JSON.</div>
    </section>
  </div>
</div>

<script>
let currentView = '7day';

function showTab(which){
  const ids=['cal','assets','agency','raw'];
  ids.forEach(id=>{
    document.getElementById('view-'+id).style.display = (id===which)?'':'none';
    document.getElementById('tab-'+id).classList.toggle('active', id===which);
  });
  if(which==='cal') loadCal(currentView);
  if(which==='assets') loadAssets();
  if(which==='agency') loadAgency();
}

async function loadCal(view){
  currentView = view;
  const el = document.getElementById('cal');
  el.innerHTML = '<div class="muted">Loading‚Ä¶</div>';
  try{
    // backend expects types: 7day | 30day | 60day | 90day
    const v = (view==='7day') ? '7day' : view.replace('day','day'); 
    const res = await fetch(`/api/calendar/${v}`);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j = await res.json();

    if(v==='7day' || v==='30day'){
      const days = j.calendar_data || [];
      el.innerHTML = '';
      days.forEach(day=>{
        const posts = (day.posts||[]).map(p=>`
          <div class="item">
            <div><strong>${p.title||''}</strong></div>
            <div class="muted">${p.platform||''} ‚Ä¢ ${p.time_slot||''} ‚Ä¢ ${p.code_name||p.assigned_code||''} ‚Ä¢ Badge ${p.badge_score||0}%</div>
            <div class="muted" style="margin-top:6px">${p.content||''}</div>
            ${p.hashtags?`<div class="muted" style="color:#86efac">${p.hashtags}</div>`:''}
          </div>
        `).join('');
        el.insertAdjacentHTML('beforeend', `
          <div class="item">
            <div><strong>${day.day_name||''}</strong> ‚Äî ${day.formatted_date||day.date||''}</div>
            <hr/>${posts||'<div class="muted">No posts</div>'}
          </div>
        `);
      });
    } else if(v==='60day'){
      const opps = j.opportunities||[];
      el.innerHTML = '';
      opps.forEach(o=>{
        el.insertAdjacentHTML('beforeend', `
          <div class="item">
            <div><strong>${o.event||o.title||'Opportunity'}</strong> ‚Äî <span class="muted">${o.date||o.date_range||''}</span></div>
            <div class="muted">${o.type||''} ‚Ä¢ Priority: ${o.priority||''}</div>
            ${o.content_ideas?`<hr/><div class="muted">Ideas: ${o.content_ideas.join(', ')}</div>`:''}
            ${o.suggested_codes?`<div class="muted">Codes: ${o.suggested_codes.join(', ')}</div>`:''}
          </div>
        `);
      });
      if(!opps.length) el.innerHTML = '<div class="muted">No opportunities returned</div>';
    } else if(v==='90day'){
      const lr = j.long_range||[];
      el.innerHTML = '';
      lr.forEach(m=>{
        el.insertAdjacentHTML('beforeend', `
          <div class="item">
            <div><strong>${m.milestone||m.title||'Milestone'}</strong> ‚Äî <span class="muted">${m.date||m.date_range||''}</span></div>
            <div class="muted">${m.type||''}</div>
            ${m.preparation_needed?`<hr/><div class="muted">Prep: ${m.preparation_needed.join(', ')}</div>`:''}
            ${m.success_metrics?`<div class="muted">Metrics: ${m.success_metrics.join(', ')}</div>`:''}
          </div>
        `);
      });
      if(!lr.length) el.innerHTML = '<div class="muted">No long-range items returned</div>';
    }
  }catch(e){
    el.innerHTML = `<div class="muted">Calendar error: ${e.message}</div>`;
  }
}

async function loadAssets(){
  const el = document.getElementById('assets');
  el.innerHTML = '<div class="muted">Loading‚Ä¶</div>';
  try{
    const res = await fetch('/api/assets');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j = await res.json();
    const arr = j.assets||[];
    el.innerHTML = '';
    arr.forEach(a=>{
      el.insertAdjacentHTML('beforeend', `
        <div class="item">
          <div><strong>${a.original_name||a.name}</strong></div>
          <div class="muted">${a.file_type||''}</div>
          <div class="muted">Badge ${a.badge_score||0}% ‚Ä¢ Code ${a.assigned_code||'‚Äî'}</div>
          <div class="muted">${a.created_date||''}</div>
        </div>
      `);
    });
    if(!arr.length) el.innerHTML = '<div class="muted">No assets</div>';
  }catch(e){
    el.innerHTML = `<div class="muted">Assets error: ${e.message}</div>`;
  }
}

async function loadAgency(){
  const el = document.getElementById('agency');
  const insightsBox = document.getElementById('insights');
  el.innerHTML = '<div class="muted">Loading‚Ä¶</div>';
  insightsBox.style.display = 'none';
  try{
    const res = await fetch('/api/deliverables');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j = await res.json();
    el.innerHTML='';
    const cp = j.current_progress||{};
    el.insertAdjacentHTML('beforeend', `
      <div class="item">
        <div><strong>${(j.current_phase||{}).name||'Phase'}</strong> ‚Äî <span class="muted">${(j.current_phase||{}).period||''}</span></div>
        <div class="muted">${(j.current_phase||{}).budget||''}</div><hr/>
        <div class="muted">Social: ${cp.social_posts?.current||0}/${cp.social_posts?.target||0} (${cp.social_posts?.progress||0}%)</div>
        <div class="muted">Creatives: ${cp.ad_creatives?.current||0}/${cp.ad_creatives?.target||0} (${cp.ad_creatives?.progress||0}%)</div>
        <div class="muted">Email: ${cp.email_campaigns?.current||0}/${cp.email_campaigns?.target||0} (${cp.email_campaigns?.progress||0}%)</div>
        <hr/><div><strong>Overall:</strong> ${(j.overall_progress||0)}%</div>
      </div>
    `);
  }catch(e){
    el.innerHTML = `<div class="muted">Agency error: ${e.message}</div>`;
  }
}

async function uploadAssets(){
  const input = document.getElementById('assetFiles');
  if(!input.files.length) return alert('Choose file(s) first');
  const fd = new FormData();
  [...input.files].forEach(f=>fd.append('files', f));
  try{
    const res = await fetch('/api/upload-assets',{method:'POST',body:fd});
    const j = await res.json();
    if(!j.success) throw new Error(j.message||'upload failed');
    alert(`Uploaded ${j.uploaded_count} asset(s)`);
    loadAssets();
  }catch(e){ alert('Upload error: '+e.message); }
}

async function uploadReport(){
  const f = document.getElementById('reportFile').files[0];
  if(!f) return alert('Choose a file first');
  const fd = new FormData(); fd.append('report', f);
  try{
    const res = await fetch('/api/upload-performance-report',{method:'POST',body:fd});
    const j = await res.json();
    if(!j.success) throw new Error(j.message||'upload failed');
    const box = document.getElementById('insights'); box.style.display='block';
    box.innerHTML = `<div><strong>Latest Insights</strong></div><hr/>` +
      (j.insights||[]).map(x=>`<div class="muted">‚Ä¢ ${x.message}</div>`).join('') || '<div class="muted">No insights</div>';
    loadAgency();
  }catch(e){ alert('Upload error: '+e.message); }
}

document.addEventListener('DOMContentLoaded', ()=>{ loadCal('7day'); });
</script>
</body>
</html>
