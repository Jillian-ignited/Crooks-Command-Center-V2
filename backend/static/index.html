<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>👑 Crooks & Castles Command Center V2 - Revenue Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'crooks-black': '#0a0a0a',
                        'crooks-orange': '#ff6b35',
                        'crooks-gold': '#ffd700',
                        'crooks-gray': '#1a1a1a'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-border {
            background: linear-gradient(45deg, #ff6b35, #ffd700, #ff6b35);
            padding: 2px;
            border-radius: 12px;
        }
        .gradient-border-content {
            background: #0a0a0a;
            border-radius: 10px;
            padding: 1.5rem;
        }
        .glow-effect {
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }
        .priority-1 { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .priority-2 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .priority-3 { background: linear-gradient(135deg, #10b981, #059669); }
        .impact-high { color: #ef4444; }
        .impact-medium { color: #f59e0b; }
        .impact-low { color: #10b981; }
        .health-excellent { color: #10b981; }
        .health-good { color: #3b82f6; }
        .health-fair { color: #f59e0b; }
        .health-needs-attention { color: #ef4444; }
        .revenue-positive { color: #10b981; }
        .revenue-negative { color: #ef4444; }
        .correlation-strong { color: #10b981; }
        .correlation-moderate { color: #f59e0b; }
        .correlation-weak { color: #ef4444; }
    </style>
</head>
<body class="bg-crooks-black text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-crooks-black via-crooks-gray to-crooks-black border-b border-crooks-orange/30">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-3xl">👑</span>
                    <div>
                        <h1 class="text-2xl font-bold text-crooks-orange">Crooks & Castles</h1>
                        <p class="text-sm text-gray-400">Revenue Intelligence Command Center</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Shopify Status</div>
                        <div id="shopifyStatus" class="text-red-400 font-semibold">🔴 Not Connected</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">System Status</div>
                        <div id="systemStatus" class="text-green-400 font-semibold">🟢 Online</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-crooks-gray border-b border-crooks-orange/20">
        <div class="container mx-auto px-6">
            <div class="flex space-x-8">
                <button onclick="showTab('revenue')" id="tab-revenue" class="tab-button px-4 py-3 text-crooks-orange border-b-2 border-crooks-orange font-semibold">
                    💰 Revenue Intelligence
                </button>
                <button onclick="showTab('overview')" id="tab-overview" class="tab-button px-4 py-3 text-gray-400 hover:text-white transition-colors">
                    📊 Strategic Overview
                </button>
                <button onclick="showTab('intelligence')" id="tab-intelligence" class="tab-button px-4 py-3 text-gray-400 hover:text-white transition-colors">
                    🧠 Intelligence
                </button>
                <button onclick="showTab('shopify')" id="tab-shopify" class="tab-button px-4 py-3 text-gray-400 hover:text-white transition-colors">
                    🛒 Shopify Setup
                </button>
                <button onclick="showTab('ingest')" id="tab-ingest" class="tab-button px-4 py-3 text-gray-400 hover:text-white transition-colors">
                    ⬆️ Data Ingest
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        
        <!-- Revenue Intelligence Tab -->
        <div id="revenue-content" class="tab-content">
            <!-- Revenue Dashboard Header -->
            <div class="gradient-border mb-8 glow-effect">
                <div class="gradient-border-content">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-crooks-orange mb-2">💰 Revenue Intelligence Dashboard</h2>
                            <p class="text-gray-400">Social media impact on actual sales performance</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">Correlation Strength</div>
                            <div id="correlationStrength" class="text-2xl font-bold">--</div>
                            <div id="correlationStatus" class="text-sm font-semibold">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-crooks-gray border border-green-500/30 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Revenue (30d)</p>
                            <p id="totalRevenue" class="text-2xl font-bold text-green-400">--</p>
                        </div>
                        <span class="text-2xl">💵</span>
                    </div>
                </div>
                <div class="bg-crooks-gray border border-blue-500/30 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Orders</p>
                            <p id="totalOrders" class="text-2xl font-bold text-blue-400">--</p>
                        </div>
                        <span class="text-2xl">🛒</span>
                    </div>
                </div>
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Avg Order Value</p>
                            <p id="avgOrderValue" class="text-2xl font-bold text-crooks-orange">--</p>
                        </div>
                        <span class="text-2xl">💳</span>
                    </div>
                </div>
                <div class="bg-crooks-gray border border-purple-500/30 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Social-Revenue Correlation</p>
                            <p id="socialCorrelation" class="text-2xl font-bold text-purple-400">--%</p>
                        </div>
                        <span class="text-2xl">📈</span>
                    </div>
                </div>
            </div>

            <!-- Revenue Drivers Analysis -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="gradient-border">
                    <div class="gradient-border-content">
                        <h3 class="text-xl font-bold text-crooks-orange mb-4">🎯 Top Revenue-Driving Hashtags</h3>
                        <div id="revenueHashtags" class="space-y-4">
                            <div class="text-gray-400">Loading hashtag revenue analysis...</div>
                        </div>
                    </div>
                </div>

                <div class="gradient-border">
                    <div class="gradient-border-content">
                        <h3 class="text-xl font-bold text-crooks-orange mb-4">📊 Social-Sales Correlation</h3>
                        <div id="correlationInsights" class="space-y-3">
                            <div class="text-gray-400">Loading correlation analysis...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue Performance Chart -->
            <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6 mb-8">
                <h3 class="text-xl font-semibold text-crooks-orange mb-4">📈 Revenue vs Social Activity</h3>
                <div class="h-64">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Strategic Revenue Insights -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-crooks-gray border border-green-500/30 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-green-400 mb-3">💡 Revenue Optimization Opportunities</h4>
                    <div id="revenueOpportunities" class="space-y-2">
                        <div class="text-gray-400">Loading revenue insights...</div>
                    </div>
                </div>
                <div class="bg-crooks-gray border border-blue-500/30 rounded-lg p-6">
                    <h4 class="text-lg font-semibold text-blue-400 mb-3">🎯 High-Performing Content Themes</h4>
                    <div id="contentThemes" class="space-y-2">
                        <div class="text-gray-400">Loading content analysis...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategic Overview Tab -->
        <div id="overview-content" class="tab-content hidden">
            <!-- Health Score Banner -->
            <div class="gradient-border mb-8 glow-effect">
                <div class="gradient-border-content">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-crooks-orange mb-2">👑 Strategic Command Overview</h2>
                            <p class="text-gray-400">Real-time competitive intelligence and strategic insights</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">Overall Health</div>
                            <div id="healthScore" class="text-3xl font-bold">--</div>
                            <div id="healthStatus" class="text-sm font-semibold">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Posts Analyzed</p>
                            <p id="totalPosts" class="text-2xl font-bold text-white">--</p>
                        </div>
                        <span class="text-2xl">📊</span>
                    </div>
                </div>
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Brands Tracked</p>
                            <p id="totalBrands" class="text-2xl font-bold text-white">--</p>
                        </div>
                        <span class="text-2xl">🏢</span>
                    </div>
                </div>
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Positive Sentiment</p>
                            <p id="positiveSentiment" class="text-2xl font-bold text-green-400">--%</p>
                        </div>
                        <span class="text-2xl">😊</span>
                    </div>
                </div>
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">C&C Rank</p>
                            <p id="ccRank" class="text-2xl font-bold text-crooks-orange">--</p>
                        </div>
                        <span class="text-2xl">👑</span>
                    </div>
                </div>
            </div>

            <!-- Prioritized Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="gradient-border">
                    <div class="gradient-border-content">
                        <h3 class="text-xl font-bold text-crooks-orange mb-4">🎯 Top 3 Prioritized Actions</h3>
                        <div id="prioritizedActions" class="space-y-4">
                            <div class="text-gray-400">Loading strategic recommendations...</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Analysis -->
                <div class="gradient-border">
                    <div class="gradient-border-content">
                        <h3 class="text-xl font-bold text-crooks-orange mb-4">📈 Strategic Analysis</h3>
                        <div id="enhancedAnalysis" class="space-y-3">
                            <div class="text-gray-400">Loading enhanced insights...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Intelligence Tab -->
        <div id="intelligence-content" class="tab-content hidden">
            <div class="gradient-border mb-6">
                <div class="gradient-border-content">
                    <h2 class="text-2xl font-bold text-crooks-orange mb-4">🧠 Competitive Intelligence</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-white" id="intPosts">--</div>
                            <div class="text-gray-400">Posts Analyzed</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-crooks-orange" id="intBrands">--</div>
                            <div class="text-gray-400">Competitors Tracked</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-400" id="intSentiment">--%</div>
                            <div class="text-gray-400">Market Sentiment</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-crooks-orange mb-4">📊 Competitor Rankings</h3>
                    <div id="competitorRankings" class="space-y-3">
                        <div class="text-gray-400">Loading competitor analysis...</div>
                    </div>
                </div>
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-crooks-orange mb-4">💡 Strategic Insights</h3>
                    <div id="strategicInsights" class="space-y-3">
                        <div class="text-gray-400">Loading strategic recommendations...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shopify Setup Tab -->
        <div id="shopify-content" class="tab-content hidden">
            <div class="gradient-border mb-6">
                <div class="gradient-border-content">
                    <h2 class="text-2xl font-bold text-crooks-orange mb-4">🛒 Shopify Integration Setup</h2>
                    <p class="text-gray-400">Connect your Shopify store to correlate social media with actual sales</p>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="shopifyConnectionStatus" class="bg-crooks-gray border border-red-500/30 rounded-lg p-6 mb-6">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">🔴</span>
                    <div>
                        <h3 class="text-lg font-semibold text-red-400">Not Connected</h3>
                        <p class="text-gray-400">Enter your Shopify credentials below to enable revenue intelligence</p>
                    </div>
                </div>
            </div>

            <!-- Setup Form -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-crooks-orange mb-4">🔑 Store Credentials</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Shop Domain</label>
                            <input type="text" id="shopDomain" placeholder="your-store-name" class="w-full bg-crooks-black border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-crooks-orange focus:outline-none">
                            <p class="text-xs text-gray-500 mt-1">Just the store name (without .myshopify.com)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Private App Access Token</label>
                            <input type="password" id="accessToken" placeholder="shpat_..." class="w-full bg-crooks-black border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-crooks-orange focus:outline-none">
                            <p class="text-xs text-gray-500 mt-1">Create a private app in your Shopify admin</p>
                        </div>
                        <button onclick="setupShopifyIntegration()" class="w-full bg-crooks-orange hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                            Connect Shopify Store
                        </button>
                    </div>
                </div>

                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-crooks-orange mb-4">📋 Setup Instructions</h3>
                    <div class="space-y-3 text-sm text-gray-300">
                        <div class="flex items-start space-x-2">
                            <span class="text-crooks-orange font-bold">1.</span>
                            <span>Go to your Shopify Admin → Apps → App and sales channel settings</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-crooks-orange font-bold">2.</span>
                            <span>Click "Develop apps" → "Create an app"</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-crooks-orange font-bold">3.</span>
                            <span>Configure API scopes: read_orders, read_customers, read_products</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-crooks-orange font-bold">4.</span>
                            <span>Install the app and copy the Admin API access token</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-crooks-orange font-bold">5.</span>
                            <span>Enter your store name and token above</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Connection -->
            <div id="connectionTest" class="hidden mt-6 bg-blue-900/30 border border-blue-500/50 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-400"></div>
                    <span class="text-blue-400 font-semibold">Testing connection...</span>
                </div>
            </div>
        </div>

        <!-- Data Ingest Tab -->
        <div id="ingest-content" class="tab-content hidden">
            <div class="gradient-border mb-6">
                <div class="gradient-border-content">
                    <h2 class="text-2xl font-bold text-crooks-orange mb-4">⬆️ Manual Data Ingest</h2>
                    <p class="text-gray-400">Upload competitive intelligence data and social media scraper results</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- File Upload -->
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-crooks-orange mb-4">📁 File Upload</h3>
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-crooks-orange transition-colors">
                        <input type="file" id="fileInput" accept=".json,.jsonl,.csv" class="hidden" onchange="handleFileUpload()">
                        <button onclick="document.getElementById('fileInput').click()" class="bg-crooks-orange hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                            Choose File
                        </button>
                        <p class="text-gray-400 mt-2">Supports JSON, JSONL, CSV files</p>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Data Source</label>
                        <input type="text" id="dataSource" placeholder="e.g., Instagram Scraper, TikTok Data" class="w-full bg-crooks-black border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-crooks-orange focus:outline-none">
                    </div>
                </div>

                <!-- JSON Paste -->
                <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-crooks-orange mb-4">📝 JSON Paste</h3>
                    <textarea id="jsonPaste" placeholder='{"posts": [...], "brand": "competitor_name"}' class="w-full h-32 bg-crooks-black border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-crooks-orange focus:outline-none font-mono text-sm"></textarea>
                    <div class="mt-4 flex space-x-4">
                        <input type="text" id="pasteSource" placeholder="Data source name" class="flex-1 bg-crooks-black border border-gray-600 rounded-lg px-4 py-2 text-white focus:border-crooks-orange focus:outline-none">
                        <button onclick="handleJSONPaste()" class="bg-crooks-orange hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                            Process Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Processing Status -->
            <div id="processingStatus" class="hidden bg-blue-900/30 border border-blue-500/50 rounded-lg p-4 mb-6">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-400"></div>
                    <span class="text-blue-400 font-semibold">Processing data...</span>
                </div>
            </div>

            <!-- Asset Library -->
            <div class="bg-crooks-gray border border-crooks-orange/30 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-crooks-orange mb-4">📚 Asset Library</h3>
                <div id="assetLibrary" class="space-y-3">
                    <div class="text-gray-400">Loading asset library...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentTab = 'revenue';
        let dataLoaded = false;
        let shopifyConnected = false;
        let revenueChart = null;

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-crooks-orange', 'border-b-2', 'border-crooks-orange');
                button.classList.add('text-gray-400');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active state to selected tab
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.remove('text-gray-400');
            activeTab.classList.add('text-crooks-orange', 'border-b-2', 'border-crooks-orange');
            
            currentTab = tabName;
            
            // Load data for specific tabs
            if (tabName === 'revenue') {
                loadRevenueIntelligence();
            } else if (tabName === 'overview' && !dataLoaded) {
                loadOverviewData();
            } else if (tabName === 'intelligence') {
                loadIntelligenceData();
            } else if (tabName === 'shopify') {
                checkShopifyStatus();
            } else if (tabName === 'ingest') {
                loadAssetLibrary();
            }
        }

        // Check Shopify Status
        async function checkShopifyStatus() {
            try {
                const response = await fetch('/shopify/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('shopifyConnectionStatus');
                const headerStatus = document.getElementById('shopifyStatus');
                
                if (data.connected) {
                    shopifyConnected = true;
                    statusElement.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">🟢</span>
                            <div>
                                <h3 class="text-lg font-semibold text-green-400">Connected to ${data.shop_info.shop_name}</h3>
                                <p class="text-gray-400">Revenue intelligence is active</p>
                            </div>
                        </div>
                    `;
                    statusElement.className = 'bg-crooks-gray border border-green-500/30 rounded-lg p-6 mb-6';
                    headerStatus.innerHTML = '🟢 Connected';
                    headerStatus.className = 'text-green-400 font-semibold';
                } else {
                    shopifyConnected = false;
                    headerStatus.innerHTML = '🔴 Not Connected';
                    headerStatus.className = 'text-red-400 font-semibold';
                }
            } catch (error) {
                console.error('Error checking Shopify status:', error);
            }
        }

        // Setup Shopify Integration
        async function setupShopifyIntegration() {
            const shopDomain = document.getElementById('shopDomain').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            
            if (!shopDomain || !accessToken) {
                alert('Please enter both shop domain and access token');
                return;
            }
            
            document.getElementById('connectionTest').classList.remove('hidden');
            
            try {
                const response = await fetch('/shopify/setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop_domain: shopDomain,
                        access_token: accessToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully connected to ${result.shop_info.shop_name}!`);
                    checkShopifyStatus();
                    document.getElementById('shopDomain').value = '';
                    document.getElementById('accessToken').value = '';
                } else {
                    alert('Connection failed: ' + result.detail);
                }
            } catch (error) {
                console.error('Setup error:', error);
                alert('Setup failed: ' + error.message);
            } finally {
                document.getElementById('connectionTest').classList.add('hidden');
            }
        }

        // Load Revenue Intelligence
        async function loadRevenueIntelligence() {
            try {
                // Check if Shopify is connected
                if (!shopifyConnected) {
                    document.getElementById('correlationStrength').textContent = 'N/A';
                    document.getElementById('correlationStatus').textContent = 'Shopify Not Connected';
                    document.getElementById('revenueHashtags').innerHTML = '<div class="text-red-400">Connect Shopify to see revenue intelligence</div>';
                    document.getElementById('correlationInsights').innerHTML = '<div class="text-red-400">Shopify integration required</div>';
                    return;
                }
                
                // Get unified dashboard data
                const response = await fetch('/shopify/dashboard');
                const data = await response.json();
                
                if (data.success && data.dashboard.sales_data_available) {
                    const dashboard = data.dashboard;
                    
                    // Update revenue metrics
                    if (dashboard.sales_metrics) {
                        document.getElementById('totalRevenue').textContent = '$' + dashboard.sales_metrics.total_revenue.toLocaleString();
                        document.getElementById('totalOrders').textContent = dashboard.sales_metrics.total_orders.toLocaleString();
                        document.getElementById('avgOrderValue').textContent = '$' + dashboard.sales_metrics.avg_order_value.toFixed(2);
                    }
                    
                    // Update correlation data
                    if (dashboard.correlation_insights && dashboard.correlation_insights.correlation_found) {
                        const correlations = dashboard.correlation_insights.correlations;
                        const strongCorrelations = dashboard.correlation_insights.strong_correlations;
                        
                        // Find strongest correlation
                        let maxCorr = 0;
                        Object.values(correlations).forEach(corr => {
                            if (Math.abs(corr) > Math.abs(maxCorr)) maxCorr = corr;
                        });
                        
                        document.getElementById('socialCorrelation').textContent = (Math.abs(maxCorr) * 100).toFixed(1) + '%';
                        
                        if (Math.abs(maxCorr) > 0.5) {
                            document.getElementById('correlationStrength').textContent = 'Strong';
                            document.getElementById('correlationStatus').textContent = 'High Impact';
                            document.getElementById('correlationStatus').className = 'text-sm font-semibold correlation-strong';
                        } else if (Math.abs(maxCorr) > 0.3) {
                            document.getElementById('correlationStrength').textContent = 'Moderate';
                            document.getElementById('correlationStatus').textContent = 'Medium Impact';
                            document.getElementById('correlationStatus').className = 'text-sm font-semibold correlation-moderate';
                        } else {
                            document.getElementById('correlationStrength').textContent = 'Weak';
                            document.getElementById('correlationStatus').textContent = 'Low Impact';
                            document.getElementById('correlationStatus').className = 'text-sm font-semibold correlation-weak';
                        }
                        
                        // Update correlation insights
                        const insightsContainer = document.getElementById('correlationInsights');
                        insightsContainer.innerHTML = '';
                        dashboard.correlation_insights.insights.forEach(insight => {
                            const div = document.createElement('div');
                            div.className = 'text-gray-300 text-sm';
                            div.textContent = '• ' + insight;
                            insightsContainer.appendChild(div);
                        });
                    }
                    
                    // Update hashtag revenue analysis
                    if (dashboard.hashtag_insights && dashboard.hashtag_insights.success) {
                        const hashtagsContainer = document.getElementById('revenueHashtags');
                        hashtagsContainer.innerHTML = '';
                        
                        dashboard.hashtag_insights.top_revenue_hashtags.slice(0, 5).forEach((hashtag, index) => {
                            const div = document.createElement('div');
                            div.className = 'flex items-center justify-between bg-crooks-black border border-gray-600 rounded p-3';
                            div.innerHTML = `
                                <div class="flex items-center space-x-3">
                                    <span class="text-crooks-orange font-bold">#${index + 1}</span>
                                    <span class="text-white">${hashtag.hashtag}</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-green-400 font-semibold">$${hashtag.avg_revenue_per_post.toFixed(2)}</div>
                                    <div class="text-gray-400 text-xs">${hashtag.post_count} posts</div>
                                </div>
                            `;
                            hashtagsContainer.appendChild(div);
                        });
                    }
                    
                } else {
                    document.getElementById('correlationStrength').textContent = 'N/A';
                    document.getElementById('correlationStatus').textContent = 'No Data';
                    document.getElementById('revenueHashtags').innerHTML = '<div class="text-gray-400">Upload social media data to see revenue correlation</div>';
                }
                
            } catch (error) {
                console.error('Error loading revenue intelligence:', error);
                document.getElementById('correlationStatus').textContent = 'Error loading data';
            }
        }

        // Load Strategic Overview Data
        async function loadOverviewData() {
            try {
                const response = await fetch('/summary/overview');
                const data = await response.json();
                
                if (data.success) {
                    const overview = data.overview;
                    
                    // Update key metrics
                    document.getElementById('totalPosts').textContent = overview.key_metrics.total_posts;
                    document.getElementById('totalBrands').textContent = overview.key_metrics.total_brands;
                    document.getElementById('positiveSentiment').textContent = overview.key_metrics.positive_sentiment + '%';
                    document.getElementById('ccRank').textContent = overview.key_metrics.cc_rank;
                    
                    // Update health score
                    document.getElementById('healthScore').textContent = overview.key_metrics.overall_health + '%';
                    const healthStatus = document.getElementById('healthStatus');
                    healthStatus.textContent = overview.key_metrics.health_status;
                    healthStatus.className = `text-sm font-semibold health-${overview.key_metrics.health_status.toLowerCase().replace(' ', '-')}`;
                    
                    // Update prioritized actions
                    const actionsContainer = document.getElementById('prioritizedActions');
                    actionsContainer.innerHTML = '';
                    overview.prioritized_actions.forEach(action => {
                        const actionDiv = document.createElement('div');
                        actionDiv.className = 'bg-crooks-black border border-gray-600 rounded-lg p-4';
                        actionDiv.innerHTML = `
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="priority-${action.priority} text-white text-xs px-2 py-1 rounded-full font-bold">${action.priority}</span>
                                    <span class="font-semibold text-white">${action.action}</span>
                                </div>
                                <span class="impact-${action.impact.toLowerCase()} text-xs font-semibold">${action.impact} Impact</span>
                            </div>
                            <p class="text-gray-300 text-sm mb-2">${action.description}</p>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-gray-400">${action.category}</span>
                                <span class="text-crooks-orange">${action.timeline}</span>
                            </div>
                        `;
                        actionsContainer.appendChild(actionDiv);
                    });
                    
                    // Update enhanced analysis
                    const analysisContainer = document.getElementById('enhancedAnalysis');
                    const analysis = overview.enhanced_analysis;
                    analysisContainer.innerHTML = `
                        <div class="space-y-3">
                            <div><span class="text-crooks-orange font-semibold">Content Performance:</span> <span class="text-gray-300">${analysis.content_performance}</span></div>
                            <div><span class="text-crooks-orange font-semibold">Trend Analysis:</span> <span class="text-gray-300">${analysis.trend_analysis}</span></div>
                            <div><span class="text-crooks-orange font-semibold">Cultural Insights:</span> <span class="text-gray-300">${analysis.cultural_insights}</span></div>
                        </div>
                    `;
                    
                    dataLoaded = true;
                }
            } catch (error) {
                console.error('Error loading overview data:', error);
                document.getElementById('healthStatus').textContent = 'Error loading data';
            }
        }

        // Load Intelligence Data
        async function loadIntelligenceData() {
            try {
                const response = await fetch('/intelligence/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ brands: [], lookback_days: 7 })
                });
                const data = await response.json();
                
                // Update intelligence metrics
                document.getElementById('intPosts').textContent = data.metrics?.total_posts || '--';
                document.getElementById('intBrands').textContent = data.metrics?.total_brands || '--';
                document.getElementById('intSentiment').textContent = (data.metrics?.positive_sentiment || 0) + '%';
                
                // Update competitor rankings
                const rankingsContainer = document.getElementById('competitorRankings');
                rankingsContainer.innerHTML = '';
                if (data.competitor_analysis && data.competitor_analysis.length > 0) {
                    data.competitor_analysis.slice(0, 5).forEach(comp => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between bg-crooks-black border border-gray-600 rounded p-3';
                        div.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <span class="text-crooks-orange font-bold">#${comp.rank}</span>
                                <span class="text-white">${comp.brand}</span>
                                <span class="text-lg">${comp.momentum}</span>
                            </div>
                            <span class="text-green-400">${comp.sentiment}%</span>
                        `;
                        rankingsContainer.appendChild(div);
                    });
                } else {
                    rankingsContainer.innerHTML = '<div class="text-gray-400">No competitor data available</div>';
                }
                
                // Update strategic insights
                const insightsContainer = document.getElementById('strategicInsights');
                insightsContainer.innerHTML = '';
                if (data.highlights && data.highlights.length > 0) {
                    data.highlights.forEach(highlight => {
                        const div = document.createElement('div');
                        div.className = 'text-gray-300 text-sm';
                        div.textContent = '• ' + highlight;
                        insightsContainer.appendChild(div);
                    });
                } else {
                    insightsContainer.innerHTML = '<div class="text-gray-400">Upload data to see insights</div>';
                }
                
            } catch (error) {
                console.error('Error loading intelligence data:', error);
                document.getElementById('competitorRankings').innerHTML = '<div class="text-red-400">Error loading competitor data</div>';
            }
        }

        // Load Asset Library
        async function loadAssetLibrary() {
            try {
                const response = await fetch('/ingest/sources');
                const data = await response.json();
                
                const libraryContainer = document.getElementById('assetLibrary');
                libraryContainer.innerHTML = '';
                
                if (data.sources && data.sources.length > 0) {
                    data.sources.forEach(source => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between bg-crooks-black border border-gray-600 rounded p-3';
                        div.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">📊</span>
                                <div>
                                    <div class="text-white font-semibold">${source.name}</div>
                                    <div class="text-gray-400 text-sm">${source.total_records} records • ${source.total_files} files</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-green-400 text-sm">${source.status}</div>
                                <div class="text-gray-400 text-xs">${new Date(source.last_updated).toLocaleDateString()}</div>
                            </div>
                        `;
                        libraryContainer.appendChild(div);
                    });
                } else {
                    libraryContainer.innerHTML = '<div class="text-gray-400">No assets uploaded yet. Upload data files to begin analysis.</div>';
                }
            } catch (error) {
                console.error('Error loading asset library:', error);
                document.getElementById('assetLibrary').innerHTML = '<div class="text-red-400">Error loading asset library</div>';
            }
        }

        // File Upload Handler
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const sourceInput = document.getElementById('dataSource');
            const file = fileInput.files[0];
            
            if (!file) return;
            if (!sourceInput.value.trim()) {
                alert('Please enter a data source name');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('source', sourceInput.value.trim());
            
            document.getElementById('processingStatus').classList.remove('hidden');
            
            try {
                const response = await fetch('/ingest/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`File uploaded successfully! Processed ${result.processing_results.total_records} records.`);
                    sourceInput.value = '';
                    fileInput.value = '';
                    loadAssetLibrary();
                    if (currentTab === 'overview') {
                        dataLoaded = false;
                        loadOverviewData();
                    }
                    if (currentTab === 'revenue') {
                        loadRevenueIntelligence();
                    }
                } else {
                    alert('Upload failed: ' + result.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            } finally {
                document.getElementById('processingStatus').classList.add('hidden');
            }
        }

        // JSON Paste Handler
        async function handleJSONPaste() {
            const jsonInput = document.getElementById('jsonPaste');
            const sourceInput = document.getElementById('pasteSource');
            
            if (!jsonInput.value.trim()) {
                alert('Please paste JSON data');
                return;
            }
            
            if (!sourceInput.value.trim()) {
                alert('Please enter a data source name');
                return;
            }
            
            try {
                const jsonData = JSON.parse(jsonInput.value);
                
                document.getElementById('processingStatus').classList.remove('hidden');
                
                const response = await fetch('/ingest/paste', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: jsonData,
                        source: sourceInput.value.trim()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Data processed successfully! Processed ${result.processing_results.total_records} records.`);
                    jsonInput.value = '';
                    sourceInput.value = '';
                    loadAssetLibrary();
                    if (currentTab === 'overview') {
                        dataLoaded = false;
                        loadOverviewData();
                    }
                    if (currentTab === 'revenue') {
                        loadRevenueIntelligence();
                    }
                } else {
                    alert('Processing failed: ' + result.message);
                }
            } catch (error) {
                console.error('JSON processing error:', error);
                alert('Invalid JSON or processing failed: ' + error.message);
            } finally {
                document.getElementById('processingStatus').classList.add('hidden');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkShopifyStatus();
            showTab('revenue');
        });
    </script>
</body>
</html>
