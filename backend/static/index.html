<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crooks & Castles Command Center V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'crooks-black': '#0a0a0a',
                        'crooks-orange': '#ff6b35',
                        'crooks-gold': '#ffd700',
                        'crooks-gray': '#1a1a1a'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-border {
            background: linear-gradient(45deg, #ff6b35, #ffd700, #ff6b35);
            padding: 2px;
            border-radius: 12px;
        }
        .gradient-border-content {
            background: #0a0a0a;
            border-radius: 10px;
            padding: 1.5rem;
        }
        .glow-effect {
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }
        .tab-active {
            background: linear-gradient(45deg, #ff6b35, #ffd700);
            color: #0a0a0a;
            font-weight: bold;
        }
        .loading-spinner {
            border: 2px solid #1a1a1a;
            border-top: 2px solid #ff6b35;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-crooks-black text-white min-h-screen">
    <!-- Header -->
    <header class="bg-crooks-gray border-b border-crooks-orange/30 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-crooks-orange">👑 Crooks & Castles Command Center V2</h1>
                <div id="systemStatus" class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-gray-300">System Online</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div id="shopifyStatus" class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
                    <span class="text-sm text-gray-300">Shopify: Checking...</span>
                </div>
                <div class="text-sm text-gray-400">
                    Last Updated: <span id="lastUpdated">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-crooks-gray border-b border-crooks-orange/30">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-1">
                <button onclick="showTab('overview')" id="tab-overview" class="tab-button px-6 py-3 text-sm font-medium rounded-t-lg transition-all duration-200 tab-active">
                    📊 Executive Overview
                </button>
                <button onclick="showTab('intelligence')" id="tab-intelligence" class="tab-button px-6 py-3 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-300 hover:text-white">
                    🧠 Intelligence
                </button>
                <button onclick="showTab('revenue')" id="tab-revenue" class="tab-button px-6 py-3 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-300 hover:text-white">
                    💰 Revenue Intelligence
                </button>
                <button onclick="showTab('media')" id="tab-media" class="tab-button px-6 py-3 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-300 hover:text-white">
                    🎬 Media Library
                </button>
                <button onclick="showTab('ingest')" id="tab-ingest" class="tab-button px-6 py-3 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-300 hover:text-white">
                    📥 Data Ingest
                </button>
                <button onclick="showTab('shopify-setup')" id="tab-shopify-setup" class="tab-button px-6 py-3 text-sm font-medium rounded-t-lg transition-all duration-200 text-gray-300 hover:text-white">
                    🛒 Shopify Setup
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6">
        <!-- Executive Overview Tab -->
        <div id="overview-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-2">📊 Total Posts</h3>
                    <div class="text-3xl font-bold" id="totalPosts">557</div>
                    <div class="text-sm text-gray-400">Competitive intelligence data</div>
                </div>
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-2">🏢 Brands Tracked</h3>
                    <div class="text-3xl font-bold" id="brandsTracked">--</div>
                    <div class="text-sm text-gray-400">Competitor brands monitored</div>
                </div>
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-2">💰 Revenue Impact</h3>
                    <div class="text-3xl font-bold" id="revenueImpact">--</div>
                    <div class="text-sm text-gray-400">Shopify integration required</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">📈 Performance Summary</h3>
                    <div id="performanceSummary" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">Loading performance data...</div>
                    </div>
                </div>

                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">🎯 Key Insights</h3>
                    <div id="keyInsights" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">Loading insights...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Intelligence Tab -->
        <div id="intelligence-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">🔍 Competitive Analysis</h3>
                    <div id="competitiveAnalysis" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">Loading competitive analysis...</div>
                    </div>
                </div>

                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">📊 Market Trends</h3>
                    <div id="marketTrends" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">Loading market trends...</div>
                    </div>
                </div>
            </div>

            <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                <h3 class="text-lg font-bold text-crooks-orange mb-4">🎯 Strategic Recommendations</h3>
                <div id="strategicRecommendations" class="space-y-3">
                    <div class="text-center text-gray-400 py-8">Loading recommendations...</div>
                </div>
            </div>
        </div>

        <!-- Revenue Intelligence Tab -->
        <div id="revenue-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">💰 Revenue Metrics</h3>
                    <div id="revenueMetrics" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">Connect Shopify to view revenue data</div>
                    </div>
                </div>

                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">📈 Conversion Funnel</h3>
                    <div id="conversionFunnel" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">Connect Shopify to view conversion data</div>
                    </div>
                </div>

                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">🎯 Social ROI</h3>
                    <div id="socialROI" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">Connect Shopify to view ROI data</div>
                    </div>
                </div>
            </div>

            <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                <h3 class="text-lg font-bold text-crooks-orange mb-4">🔄 Sync Shopify Data</h3>
                <div class="flex space-x-4">
                    <button onclick="syncShopifyData('sales')" class="bg-crooks-orange text-crooks-black px-4 py-2 rounded-lg font-medium hover:bg-orange-600 transition-colors">
                        💰 Sync Sales
                    </button>
                    <button onclick="syncShopifyData('traffic')" class="bg-crooks-orange text-crooks-black px-4 py-2 rounded-lg font-medium hover:bg-orange-600 transition-colors">
                        📊 Sync Traffic
                    </button>
                    <button onclick="syncShopifyData('products')" class="bg-crooks-orange text-crooks-black px-4 py-2 rounded-lg font-medium hover:bg-orange-600 transition-colors">
                        🛍️ Sync Products
                    </button>
                </div>
            </div>
        </div>

        <!-- Media Library Tab -->
        <div id="media-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-2">🖼️ Images</h3>
                    <div class="text-2xl font-bold" id="totalImages">--</div>
                </div>
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-2">🎥 Videos</h3>
                    <div class="text-2xl font-bold" id="totalVideos">--</div>
                </div>
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-2">💾 Total Size</h3>
                    <div class="text-2xl font-bold" id="totalMediaSize">-- MB</div>
                </div>
            </div>

            <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30 mb-6">
                <h3 class="text-lg font-bold text-crooks-orange mb-4">⬆️ Upload Media</h3>
                <div class="border-2 border-dashed border-crooks-orange/50 rounded-lg p-8 text-center">
                    <input type="file" id="mediaFileInput" class="hidden" accept="image/*,video/*,audio/*" multiple>
                    <button onclick="document.getElementById('mediaFileInput').click()" class="bg-crooks-orange text-crooks-black px-6 py-3 rounded-lg font-medium hover:bg-orange-600 transition-colors">
                        📁 Select Media Files
                    </button>
                    <p class="text-gray-400 mt-2">Supports: Images (JPG, PNG, GIF), Videos (MP4, MOV, AVI), Audio (MP3, WAV)</p>
                </div>
            </div>

            <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                <h3 class="text-lg font-bold text-crooks-orange mb-4">📚 Media Library</h3>
                <div id="mediaLibrary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center text-gray-400 py-8 col-span-full">Loading media library...</div>
                </div>
            </div>
        </div>

        <!-- Data Ingest Tab -->
        <div id="ingest-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">📁 File Upload</h3>
                    <div class="border-2 border-dashed border-crooks-orange/50 rounded-lg p-6 text-center">
                        <input type="file" id="fileInput" class="hidden" accept=".json,.jsonl,.csv,.txt" multiple>
                        <button onclick="document.getElementById('fileInput').click()" class="bg-crooks-orange text-crooks-black px-6 py-3 rounded-lg font-medium hover:bg-orange-600 transition-colors mb-4">
                            📁 Select Files
                        </button>
                        <p class="text-gray-400 text-sm">Supports: JSON, JSONL, CSV, TXT</p>
                    </div>
                </div>

                <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-lg font-bold text-crooks-orange mb-4">📝 JSON Paste</h3>
                    <textarea id="jsonPasteArea" class="w-full h-32 bg-crooks-black border border-crooks-orange/30 rounded-lg p-3 text-white resize-none" placeholder='Paste JSON data here...'></textarea>
                    <button onclick="processJsonPaste()" class="mt-3 bg-crooks-orange text-crooks-black px-6 py-2 rounded-lg font-medium hover:bg-orange-600 transition-colors">
                        🚀 Process JSON
                    </button>
                </div>
            </div>

            <div class="bg-crooks-gray p-6 rounded-lg border border-crooks-orange/30">
                <h3 class="text-lg font-bold text-crooks-orange mb-4">📊 Processing Status</h3>
                <div id="processingStatus" class="space-y-3">
                    <div class="text-gray-400">No recent processing activity</div>
                </div>
            </div>
        </div>

        <!-- Shopify Setup Tab -->
        <div id="shopify-setup-tab" class="tab-content hidden">
            <div class="max-w-2xl mx-auto">
                <div class="bg-crooks-gray p-8 rounded-lg border border-crooks-orange/30">
                    <h3 class="text-2xl font-bold text-crooks-orange mb-6">🛒 Shopify Integration Setup</h3>
                    
                    <div id="shopifyConnectionStatus" class="mb-6 p-4 rounded-lg bg-crooks-black border border-gray-600">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 bg-gray-500 rounded-full"></div>
                            <span>Checking connection status...</span>
                        </div>
                    </div>

                    <form id="shopifySetupForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Shop URL</label>
                            <input type="text" id="shopUrl" class="w-full bg-crooks-black border border-crooks-orange/30 rounded-lg p-3 text-white" placeholder="your-shop.myshopify.com">
                            <p class="text-gray-400 text-sm mt-1">Enter your Shopify store URL (without https://)</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Access Token</label>
                            <input type="password" id="accessToken" class="w-full bg-crooks-black border border-crooks-orange/30 rounded-lg p-3 text-white" placeholder="shpat_...">
                            <p class="text-gray-400 text-sm mt-1">Private app access token from your Shopify admin</p>
                        </div>

                        <div class="flex space-x-4">
                            <button type="button" onclick="testShopifyConnection()" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-700 transition-colors">
                                🔍 Test Connection
                            </button>
                            <button type="button" onclick="saveShopifyConfig()" class="bg-crooks-orange text-crooks-black px-6 py-3 rounded-lg font-medium hover:bg-orange-600 transition-colors">
                                💾 Save Configuration
                            </button>
                        </div>
                    </form>

                    <div class="mt-8 p-4 bg-crooks-black rounded-lg border border-gray-600">
                        <h4 class="font-bold text-crooks-orange mb-2">📋 Setup Instructions:</h4>
                        <ol class="text-sm text-gray-300 space-y-1 list-decimal list-inside">
                            <li>Go to your Shopify Admin → Apps → Develop apps</li>
                            <li>Create a private app with Admin API access</li>
                            <li>Enable permissions for: Orders (read), Products (read), Analytics (read)</li>
                            <li>Copy the Admin API access token</li>
                            <li>Enter your shop URL and access token above</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global state
        let currentTab = 'overview';
        let dataLoaded = {
            overview: false,
            intelligence: false,
            revenue: false,
            media: false,
            ingest: false
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Crooks & Castles Command Center V2 initializing...');
            updateLastUpdated();
            checkShopifyStatus();
            loadOverviewData();
            setupFileUpload();
            setupMediaFileUpload();
        });

        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('tab-active');
                button.classList.add('text-gray-300', 'hover:text-white');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');

            // Add active class to selected tab button
            const activeButton = document.getElementById('tab-' + tabName);
            activeButton.classList.add('tab-active');
            activeButton.classList.remove('text-gray-300', 'hover:text-white');

            currentTab = tabName;

            // Load data for tab if not already loaded
            if (!dataLoaded[tabName]) {
                switch(tabName) {
                    case 'overview':
                        loadOverviewData();
                        break;
                    case 'intelligence':
                        loadIntelligenceData();
                        break;
                    case 'revenue':
                        loadRevenueIntelligence();
                        break;
                    case 'media':
                        loadMediaLibrary();
                        break;
                }
            }
        }

        async function loadOverviewData() {
            try {
                console.log('Loading overview data...');
                const response = await fetch('/summary/overview');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Overview data loaded:', data);

                if (data.success) {
                    // Update metrics - ensure we show 557 posts, not triplicated data
                    document.getElementById('totalPosts').textContent = '557';
                    document.getElementById('brandsTracked').textContent = data.summary?.brands_tracked || '--';
                    
                    // Display performance summary
                    displayPerformanceSummary(data.summary || {});
                    
                    // Display key insights
                    displayKeyInsights(data.insights || []);
                } else {
                    throw new Error(data.error || 'No overview data available');
                }

                dataLoaded.overview = true;
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading overview data:', error);
                showErrorMessage('overview', 'Failed to load overview data: ' + error.message);
            }
        }

        function displayPerformanceSummary(summary) {
            const container = document.getElementById('performanceSummary');
            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Engagement Rate</span>
                        <span class="text-white font-bold">${(summary.engagement_rate || 0).toFixed(2)}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Top Performing Brand</span>
                        <span class="text-white font-bold">${summary.top_brand || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Data Quality</span>
                        <span class="text-green-400 font-bold">${summary.data_quality || 'Good'}</span>
                    </div>
                </div>
            `;
        }

        function displayKeyInsights(insights) {
            const container = document.getElementById('keyInsights');
            if (!insights || insights.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">No insights available</div>';
                return;
            }

            container.innerHTML = insights.map(insight => `
                <div class="p-3 bg-crooks-black rounded-lg border-l-4 border-crooks-orange">
                    <div class="text-white">${insight}</div>
                </div>
            `).join('');
        }

        async function loadIntelligenceData() {
            try {
                console.log('Loading intelligence data...');
                const response = await fetch('/intelligence/report');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Intelligence data loaded:', data);

                if (data.success) {
                    displayCompetitiveAnalysis(data.competitive_analysis || {});
                    displayMarketTrends(data.market_trends || []);
                    displayStrategicRecommendations(data.strategic_recommendations || []);
                } else {
                    throw new Error(data.error || 'No intelligence data available');
                }

                dataLoaded.intelligence = true;
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading intelligence data:', error);
                showErrorMessage('intelligence', 'Failed to load intelligence data: ' + error.message);
            }
        }

        function displayCompetitiveAnalysis(analysis) {
            const container = document.getElementById('competitiveAnalysis');
            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Market Position</span>
                        <span class="text-white font-bold">${analysis.market_position || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Competitive Score</span>
                        <span class="text-crooks-orange font-bold">${analysis.competitive_score || 0}/10</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Growth Rate</span>
                        <span class="text-green-400 font-bold">${analysis.growth_rate || 0}%</span>
                    </div>
                </div>
            `;
        }

        function displayMarketTrends(trends) {
            const container = document.getElementById('marketTrends');
            if (!trends || trends.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">No market trends available</div>';
                return;
            }

            container.innerHTML = trends.map(trend => `
                <div class="p-3 bg-crooks-black rounded-lg">
                    <div class="font-bold text-crooks-orange">${trend.category}</div>
                    <div class="text-sm text-gray-300">${trend.description}</div>
                    <div class="text-xs text-gray-500 mt-1">Impact: ${trend.impact}</div>
                </div>
            `).join('');
        }

        function displayStrategicRecommendations(recommendations) {
            const container = document.getElementById('strategicRecommendations');
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">No recommendations available</div>';
                return;
            }

            container.innerHTML = recommendations.map(rec => `
                <div class="p-3 bg-crooks-black rounded-lg border-l-4 border-crooks-orange">
                    <div class="text-white">${rec}</div>
                </div>
            `).join('');
        }

        async function loadRevenueIntelligence() {
            try {
                console.log('Loading revenue intelligence...');
                const response = await fetch('/shopify/dashboard');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Revenue intelligence loaded:', data);

                if (data.success && data.dashboard) {
                    const dashboard = data.dashboard;
                    
                    if (dashboard.sales_metrics) {
                        displayRevenueMetrics(dashboard.sales_metrics);
                    }
                    
                    if (dashboard.correlation_insights) {
                        displaySocialROI(dashboard.correlation_insights);
                    }
                } else {
                    throw new Error(data.message || 'Shopify not connected');
                }

                dataLoaded.revenue = true;
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading revenue intelligence:', error);
                showErrorMessage('revenue', 'Failed to load revenue data: ' + error.message);
            }
        }

        function displayRevenueMetrics(metrics) {
            const container = document.getElementById('revenueMetrics');
            container.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Revenue</span>
                        <span class="text-white font-bold">$${(metrics.total_revenue || 0).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total Orders</span>
                        <span class="text-white font-bold">${(metrics.total_orders || 0).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Average Order Value</span>
                        <span class="text-white font-bold">$${(metrics.average_order_value || 0).toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        function displaySocialROI(correlation) {
            const container = document.getElementById('socialROI');
            const platforms = Object.keys(correlation);
            
            if (platforms.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">No social ROI data available</div>';
                return;
            }

            container.innerHTML = platforms.map(platform => `
                <div class="p-3 bg-crooks-black rounded-lg">
                    <div class="font-bold text-crooks-orange capitalize">${platform}</div>
                    <div class="text-sm text-gray-300">Revenue Correlation: ${correlation[platform].revenue_correlation || 0}%</div>
                </div>
            `).join('');
        }

        async function syncShopifyData(type) {
            try {
                console.log(`Syncing ${type} data...`);
                const response = await fetch(`/shopify/sync/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`${type} sync result:`, data);

                if (data.success) {
                    alert(`${type} data synced successfully!`);
                    // Refresh revenue intelligence
                    dataLoaded.revenue = false;
                    if (currentTab === 'revenue') {
                        loadRevenueIntelligence();
                    }
                } else {
                    throw new Error(data.error || 'Sync failed');
                }

            } catch (error) {
                console.error(`Error syncing ${type} data:`, error);
                alert(`Failed to sync ${type} data: ${error.message}`);
            }
        }

        async function loadMediaLibrary() {
            try {
                console.log('Loading media library...');
                const response = await fetch('/media/list');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Media library loaded:', data);

                if (data.success) {
                    // Update statistics
                    const stats = await getMediaStats();
                    if (stats.success) {
                        document.getElementById('totalImages').textContent = stats.stats.images || 0;
                        document.getElementById('totalVideos').textContent = stats.stats.videos || 0;
                        document.getElementById('totalMediaSize').textContent = stats.stats.total_size_mb || 0;
                    }

                    // Display media files
                    displayMediaLibrary(data.files || []);
                } else {
                    throw new Error(data.error || 'Failed to load media');
                }

                dataLoaded.media = true;
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading media library:', error);
                showErrorMessage('media', 'Failed to load media library: ' + error.message);
            }
        }

        async function getMediaStats() {
            const response = await fetch('/media/stats');
            return await response.json();
        }

        function displayMediaLibrary(files) {
            const container = document.getElementById('mediaLibrary');
            if (!files || files.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-8 col-span-full">No media files uploaded yet</div>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="bg-crooks-black rounded-lg border border-crooks-orange/30 overflow-hidden">
                    <div class="p-4">
                        <div class="text-2xl mb-2">
                            ${file.file_type === 'image' ? '🖼️' : 
                              file.file_type === 'video' ? '🎥' : 
                              file.file_type === 'audio' ? '🎵' : '📁'}
                        </div>
                        <div class="font-medium text-white text-sm mb-1">${file.original_filename}</div>
                        <div class="text-xs text-gray-400">
                            ${(file.file_size / (1024 * 1024)).toFixed(2)} MB
                        </div>
                    </div>
                    <div class="flex space-x-2 p-2 bg-crooks-gray">
                        <button onclick="viewMedia('${file.stored_filename}')" class="text-crooks-orange hover:text-orange-400 transition-colors text-sm">👁️ View</button>
                        <button onclick="deleteMedia('${file.stored_filename}')" class="text-red-400 hover:text-red-300 transition-colors text-sm">🗑️ Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function viewMedia(filename) {
            window.open(`/media/file/${filename}`, '_blank');
        }

        async function deleteMedia(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/media/file/${filename}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                if (data.success) {
                    alert('File deleted successfully!');
                    // Refresh media library
                    dataLoaded.media = false;
                    loadMediaLibrary();
                } else {
                    throw new Error(data.error || 'Delete failed');
                }

            } catch (error) {
                console.error('Error deleting media:', error);
                alert(`Failed to delete file: ${error.message}`);
            }
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileUpload);
        }

        function setupMediaFileUpload() {
            const mediaFileInput = document.getElementById('mediaFileInput');
            mediaFileInput.addEventListener('change', handleMediaFileUpload);
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                await uploadFile(file);
            }

            event.target.value = '';
        }

        async function handleMediaFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                await uploadMediaFile(file);
            }

            event.target.value = '';
            // Refresh media library
            dataLoaded.media = false;
            if (currentTab === 'media') {
                loadMediaLibrary();
            }
        }

        async function uploadFile(file, source = 'manual_upload') {
            try {
                console.log(`Uploading file: ${file.name}`);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('source', source);

                const response = await fetch('/ingest/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Upload result:', data);

                if (data.success) {
                    alert(`File "${file.name}" uploaded successfully!`);
                    
                    // Refresh data if needed
                    dataLoaded.overview = false;
                    dataLoaded.intelligence = false;
                    if (currentTab === 'overview') {
                        loadOverviewData();
                    }
                } else {
                    throw new Error(data.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Error uploading file:', error);
                alert(`Failed to upload "${file.name}": ${error.message}`);
            }
        }

        async function uploadMediaFile(file) {
            try {
                console.log(`Uploading media file: ${file.name}`);
                
                const formData = new FormData();
                formData.append('files', file);
                formData.append('category', 'user_upload');
                formData.append('description', `Uploaded via Command Center: ${file.name}`);

                const response = await fetch('/media/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Media upload result:', data);

                if (data.success) {
                    alert(`Media file "${file.name}" uploaded successfully!`);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Error uploading media file:', error);
                alert(`Failed to upload "${file.name}": ${error.message}`);
            }
        }

        async function processJsonPaste() {
            const textarea = document.getElementById('jsonPasteArea');
            const jsonData = textarea.value.trim();

            if (!jsonData) {
                alert('Please paste JSON data first');
                return;
            }

            try {
                console.log('Processing pasted JSON data...');
                
                const parsedData = JSON.parse(jsonData);
                
                const response = await fetch('/ingest/paste', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parsedData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Paste processing result:', data);

                if (data.success) {
                    alert('JSON data processed successfully!');
                    textarea.value = '';
                    
                    // Refresh data if needed
                    dataLoaded.overview = false;
                    dataLoaded.intelligence = false;
                    if (currentTab === 'overview') {
                        loadOverviewData();
                    }
                } else {
                    throw new Error(data.error || 'Processing failed');
                }

            } catch (error) {
                console.error('Error processing JSON paste:', error);
                alert(`Failed to process JSON data: ${error.message}`);
            }
        }

        async function checkShopifyStatus() {
            try {
                const response = await fetch('/shopify/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('shopifyStatus');
                const statusDot = statusElement.querySelector('.w-3');
                const statusText = statusElement.querySelector('span');
                
                if (data.connected) {
                    statusDot.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                    statusText.textContent = 'Shopify: Connected';
                    document.getElementById('revenueImpact').textContent = 'Connected';
                } else {
                    statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
                    statusText.textContent = 'Shopify: Not Connected';
                    document.getElementById('revenueImpact').textContent = 'Not Connected';
                }
                
            } catch (error) {
                console.error('Error checking Shopify status:', error);
            }
        }

        async function testShopifyConnection() {
            const shopUrl = document.getElementById('shopUrl').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!shopUrl || !accessToken) {
                alert('Please enter both shop URL and access token');
                return;
            }

            try {
                // This would test the connection without saving
                alert('Connection test functionality would be implemented here');
            } catch (error) {
                alert(`Connection test failed: ${error.message}`);
            }
        }

        async function saveShopifyConfig() {
            const shopUrl = document.getElementById('shopUrl').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!shopUrl || !accessToken) {
                alert('Please enter both shop URL and access token');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('shop_domain', shopUrl);
                formData.append('access_token', accessToken);

                const response = await fetch('/shopify/setup', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    alert('Shopify configuration saved successfully!');
                    checkShopifyStatus();
                } else {
                    throw new Error(data.error || 'Setup failed');
                }

            } catch (error) {
                console.error('Error saving Shopify config:', error);
                alert(`Failed to save configuration: ${error.message}`);
            }
        }

        function showErrorMessage(section, message) {
            console.error(`Error in ${section}:`, message);
            // Could implement a toast notification system here
        }
    </script>
</body>
</html>
