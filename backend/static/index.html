<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crooks Command Center</title>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0a0a0a;
            color: #f0f0f0;
        }
        
        /* Header styles */
        .header {
            background-color: rgba(20, 20, 20, 0.8);
            border-bottom: 1px solid #333;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .logo {
            color: #f0f0f0;
            font-size: 18px;
            font-weight: 600;
            text-decoration: none;
        }
        
        .nav {
            display: flex;
            gap: 10px;
        }
        
        .nav a {
            color: #f0f0f0;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .version {
            font-size: 12px;
            color: #888;
        }
        
        /* Main content styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 30px;
        }
        
        h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        /* Module grid styles */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .module-card {
            background: linear-gradient(to bottom right, rgba(30, 30, 30, 0.8), rgba(20, 20, 20, 0.8));
            border: 1px solid;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .module-card a {
            color: #f0f0f0;
            text-decoration: none;
            display: block;
            font-size: 18px;
            font-weight: 500;
        }
        
        .module-card::after {
            content: attr(data-number);
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Module specific colors */
        .module-executive {
            border-color: #9c27b0;
        }
        
        .module-intelligence {
            border-color: #ff5722;
        }
        
        .module-content {
            border-color: #4caf50;
        }
        
        .module-asset {
            border-color: #e91e63;
        }
        
        .module-upload {
            border-color: #2196f3;
        }
        
        .module-calendar {
            border-color: #ff9800;
        }
        
        .module-summary {
            border-color: #8bc34a;
        }
        
        .module-agency {
            border-color: #3f51b5;
        }
        
        .module-shopify {
            border-color: #ffc107;
        }
        
        /* Dashboard styles */
        .dashboard {
            display: none;
            margin-top: 30px;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .dashboard-card {
            background: linear-gradient(to bottom right, rgba(30, 30, 30, 0.8), rgba(20, 20, 20, 0.8));
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        
        .dashboard-card h3 {
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            font-size: 18px;
        }
        
        /* Intelligence recommendations styles */
        .intelligence-recommendations {
            margin-top: 30px;
            background: linear-gradient(to right, rgba(30, 30, 30, 0.8), rgba(20, 20, 20, 0.8));
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
        }
        
        .recommendation-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .recommendation-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .recommendation-title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .recommendation-title::before {
            content: "→";
            margin-right: 8px;
            color: #ff5722;
        }
        
        .recommendation-description {
            color: #ccc;
            font-size: 14px;
        }
        
        .recommendation-source {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .recommendation-priority-high {
            border-left: 3px solid #f44336;
            padding-left: 10px;
        }
        
        .recommendation-priority-medium {
            border-left: 3px solid #ff9800;
            padding-left: 10px;
        }
        
        .recommendation-priority-low {
            border-left: 3px solid #4caf50;
            padding-left: 10px;
        }
        
        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* JSON formatting */
        pre {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
        }
        
        .json-key {
            color: #f8c555;
        }
        
        .json-value {
            color: #7ec699;
        }
        
        .json-string {
            color: #f08d49;
        }
        
        .json-number {
            color: #cc99cd;
        }
        
        .json-boolean {
            color: #56b6c2;
        }
        
        .json-null {
            color: #c678dd;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <a href="#" class="logo">Crooks Command Center</a>
        <div class="nav">
            <a href="#" data-page="dashboard">Dashboard</a>
            <a href="#" data-page="executive">Executive Overview</a>
            <a href="#" data-page="intelligence">Intelligence</a>
            <a href="#" data-page="executive-summary">Executive Summary</a>
            <a href="#" data-page="calendar">Calendar</a>
            <a href="#" data-page="agency">Agency</a>
        </div>
        <div class="version">v2.1</div>
    </div>
    
    <!-- Main content -->
    <div class="container">
        <h1>Crooks Command Center</h1>
        
        <h2>Choose a module:</h2>
        
        <div class="module-grid">
            <div class="module-card module-executive" data-number="7">
                <a href="#" data-module="executive">Executive Overview →</a>
            </div>
            
            <div class="module-card module-intelligence" data-number="8">
                <a href="#" data-module="intelligence">Intelligence →</a>
            </div>
            
            <div class="module-card module-content" data-number="9">
                <a href="#" data-module="content">Content Creation →</a>
            </div>
            
            <div class="module-card module-asset" data-number="10">
                <a href="#" data-module="asset">Asset Library →</a>
            </div>
            
            <div class="module-card module-upload" data-number="11">
                <a href="#" data-module="upload">Upload (Data & Media) →</a>
            </div>
            
            <div class="module-card module-calendar" data-number="12">
                <a href="#" data-module="calendar">Calendar →</a>
            </div>
            
            <div class="module-card module-summary" data-number="13">
                <a href="#" data-module="summary">Summary →</a>
            </div>
            
            <div class="module-card module-agency" data-number="14">
                <a href="#" data-module="agency">Agency →</a>
            </div>
            
            <div class="module-card module-shopify" data-number="15">
                <a href="#" data-module="shopify">Shopify →</a>
            </div>
        </div>
        
        <!-- Intelligence Recommendations Section (hidden by default) -->
        <div class="intelligence-recommendations" id="intelligence-recommendations" style="display: none;">
            <h2>Intelligence-Driven Recommendations</h2>
            <div id="recommendations-container">
                <div class="loading-container">
                    Loading recommendations <span class="loading"></span>
                </div>
            </div>
        </div>
        
        <!-- Module dashboards will be loaded here -->
        <div id="module-dashboards"></div>
    </div>
    
    <!-- Main application script -->
    <script>
        // API client for making requests to the backend
        const APIClient = {
            baseUrl: '',
            
            // Helper method to construct API URLs
            getUrl(endpoint) {
                // Ensure endpoint starts with /api/
                if (!endpoint.startsWith('/api/')) {
                    endpoint = '/api/' + endpoint.replace(/^\/+/, '');
                }
                return this.baseUrl + endpoint;
            },
            
            // GET request
            async get(endpoint) {
                try {
                    const response = await fetch(this.getUrl(endpoint));
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Error fetching ${endpoint}:`, error);
                    return { success: false, error: error.message };
                }
            },
            
            // POST request
            async post(endpoint, data) {
                try {
                    const response = await fetch(this.getUrl(endpoint), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Error posting to ${endpoint}:`, error);
                    return { success: false, error: error.message };
                }
            }
        };
        
        // Helper function to format JSON for display
        function formatJSON(obj) {
            if (!obj) return '';
            
            // Convert the object to a JSON string with indentation
            const jsonString = JSON.stringify(obj, null, 2);
            
            // Apply syntax highlighting
            const highlighted = jsonString
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                })
                .replace(/\n/g, '<br>')
                .replace(/\s{2}/g, '&nbsp;&nbsp;');
            
            return highlighted;
        }
        
        // Module loader
        const ModuleLoader = {
            async loadModule(moduleName) {
                const dashboardsContainer = document.getElementById('module-dashboards');
                
                // Clear existing content
                dashboardsContainer.innerHTML = '';
                
                // Create dashboard container
                const dashboard = document.createElement('div');
                dashboard.className = 'dashboard active';
                dashboard.id = `${moduleName}-dashboard`;
                
                // Show loading state
                dashboard.innerHTML = `<h2>${this.getModuleTitle(moduleName)}</h2><div class="loading-container">Loading ${moduleName} data <span class="loading"></span></div>`;
                dashboardsContainer.appendChild(dashboard);
                
                try {
                    // Load module data
                    const data = await this.fetchModuleData(moduleName);
                    
                    // Render module content
                    this.renderModuleContent(moduleName, data, dashboard);
                } catch (error) {
                    dashboard.innerHTML = `<h2>${this.getModuleTitle(moduleName)}</h2><div class="error">Error loading module: ${error.message}</div>`;
                }
            },
            
            getModuleTitle(moduleName) {
                const titles = {
                    'executive': 'Executive Overview',
                    'intelligence': 'Intelligence',
                    'content': 'Content Creation',
                    'asset': 'Asset Library',
                    'upload': 'Upload (Data & Media)',
                    'calendar': 'Calendar',
                    'summary': 'Summary',
                    'agency': 'Agency',
                    'shopify': 'Shopify'
                };
                
                return titles[moduleName] || moduleName.charAt(0).toUpperCase() + moduleName.slice(1);
            },
            
            async fetchModuleData(moduleName) {
                // Map module names to API endpoints
                const endpoints = {
                    'executive': 'executive/overview',
                    'intelligence': 'intelligence/dashboard',
                    'content': 'content/dashboard',
                    'asset': 'media/library',
                    'upload': 'ingest/overview',
                    'calendar': 'calendar/upcoming',
                    'summary': 'summary/dashboard',
                    'agency': 'agency/dashboard',
                    'shopify': 'shopify'
                };
                
                const endpoint = endpoints[moduleName];
                if (!endpoint) {
                    throw new Error(`Unknown module: ${moduleName}`);
                }
                
                return await APIClient.get(endpoint);
            },
            
            renderModuleContent(moduleName, data, container) {
                // Clear loading state
                container.innerHTML = `<h2>${this.getModuleTitle(moduleName)}</h2>`;
                
                // Create content based on module type
                switch (moduleName) {
                    case 'executive':
                        this.renderExecutiveModule(data, container);
                        break;
                    case 'intelligence':
                        this.renderIntelligenceModule(data, container);
                        break;
                    case 'agency':
                        this.renderAgencyModule(data, container);
                        break;
                    case 'shopify':
                        this.renderShopifyModule(data, container);
                        break;
                    default:
                        // Generic rendering for other modules
                        this.renderGenericModule(data, container);
                }
            },
            
            renderExecutiveModule(data, container) {
                const dashboardGrid = document.createElement('div');
                dashboardGrid.className = 'dashboard-grid';
                
                // KPI Card
                const kpiCard = document.createElement('div');
                kpiCard.className = 'dashboard-card';
                kpiCard.innerHTML = `
                    <h3>Key Performance Indicators</h3>
                    <div class="kpi-grid">
                        <div class="kpi-item">
                            <div class="kpi-label">Revenue</div>
                            <div class="kpi-value">$${data.revenue ? data.revenue.toLocaleString() : '—'}</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Engagement</div>
                            <div class="kpi-value">${data.engagement ? data.engagement.toLocaleString() : '—'}</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-label">Conversion Rate</div>
                            <div class="kpi-value">${data.conversion_rate ? data.conversion_rate.toFixed(2) + '%' : '—'}</div>
                        </div>
                    </div>
                `;
                
                // Projects Card
                const projectsCard = document.createElement('div');
                projectsCard.className = 'dashboard-card';
                projectsCard.innerHTML = `
                    <h3>Active Projects</h3>
                    <div class="projects-list">
                        ${data.projects && data.projects.length > 0 ? 
                            data.projects.map(project => `
                                <div class="project-item">
                                    <div class="project-name">${project.name}</div>
                                    <div class="project-status">${project.status}</div>
                                    <div class="project-progress">
                                        <div class="progress-bar" style="width: ${project.progress}%"></div>
                                    </div>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No active projects</div>'
                        }
                    </div>
                `;
                
                // Alerts Card
                const alertsCard = document.createElement('div');
                alertsCard.className = 'dashboard-card';
                alertsCard.innerHTML = `
                    <h3>Alerts & Notifications</h3>
                    <div class="alerts-list">
                        ${data.alerts && data.alerts.length > 0 ? 
                            data.alerts.map(alert => `
                                <div class="alert-item alert-${alert.priority}">
                                    <div class="alert-title">${alert.title}</div>
                                    <div class="alert-message">${alert.message}</div>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No alerts</div>'
                        }
                    </div>
                `;
                
                dashboardGrid.appendChild(kpiCard);
                dashboardGrid.appendChild(projectsCard);
                dashboardGrid.appendChild(alertsCard);
                container.appendChild(dashboardGrid);
            },
            
            renderIntelligenceModule(data, container) {
                const dashboardGrid = document.createElement('div');
                dashboardGrid.className = 'dashboard-grid';
                
                // Competitive Analysis Card
                const competitiveCard = document.createElement('div');
                competitiveCard.className = 'dashboard-card';
                competitiveCard.innerHTML = `
                    <h3>Competitive Analysis</h3>
                    <div class="competitive-summary">
                        <div class="metric">
                            <div class="metric-label">Tracked Competitors</div>
                            <div class="metric-value">${data.competitors_count || '—'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Active Campaigns</div>
                            <div class="metric-value">${data.campaigns_count || '—'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Market Share Trend</div>
                            <div class="metric-value">${data.market_share_trend ? (data.market_share_trend > 0 ? '+' : '') + data.market_share_trend.toFixed(1) + '%' : '—'}</div>
                        </div>
                    </div>
                `;
                
                // Trend Analysis Card
                const trendCard = document.createElement('div');
                trendCard.className = 'dashboard-card';
                trendCard.innerHTML = `
                    <h3>Trend Analysis</h3>
                    <div class="trends-list">
                        ${data.trends && data.trends.length > 0 ? 
                            data.trends.map(trend => `
                                <div class="trend-item">
                                    <div class="trend-name">${trend.name}</div>
                                    <div class="trend-impact">Impact: ${trend.impact}</div>
                                    <div class="trend-opportunity">Opportunity Score: ${trend.opportunity_score}</div>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No trend data available</div>'
                        }
                    </div>
                `;
                
                // Recommendations Card
                const recommendationsCard = document.createElement('div');
                recommendationsCard.className = 'dashboard-card';
                recommendationsCard.innerHTML = `
                    <h3>Strategic Recommendations</h3>
                    <div class="recommendations-list">
                        ${data.recommendations && data.recommendations.length > 0 ? 
                            data.recommendations.map(rec => `
                                <div class="recommendation-item recommendation-priority-${rec.priority}">
                                    <div class="recommendation-title">${rec.title}</div>
                                    <div class="recommendation-description">${rec.description}</div>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No recommendations available</div>'
                        }
                    </div>
                `;
                
                dashboardGrid.appendChild(competitiveCard);
                dashboardGrid.appendChild(trendCard);
                dashboardGrid.appendChild(recommendationsCard);
                container.appendChild(dashboardGrid);
            },
            
            renderAgencyModule(data, container) {
                const dashboardGrid = document.createElement('div');
                dashboardGrid.className = 'dashboard-grid';
                
                // Projects Card
                const projectsCard = document.createElement('div');
                projectsCard.className = 'dashboard-card';
                projectsCard.innerHTML = `
                    <h3>Agency Projects</h3>
                    <div class="projects-list">
                        ${data.projects && data.projects.length > 0 ? 
                            data.projects.map(project => `
                                <div class="project-item">
                                    <div class="project-name">${project.name}</div>
                                    <div class="project-client">${project.client}</div>
                                    <div class="project-status">${project.status}</div>
                                    <div class="project-progress">
                                        <div class="progress-bar" style="width: ${project.progress}%"></div>
                                    </div>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No projects available</div>'
                        }
                    </div>
                `;
                
                // Deliverables Card
                const deliverablesCard = document.createElement('div');
                deliverablesCard.className = 'dashboard-card';
                deliverablesCard.innerHTML = `
                    <h3>Upcoming Deliverables</h3>
                    <div class="deliverables-list">
                        ${data.deliverables && data.deliverables.length > 0 ? 
                            data.deliverables.map(deliverable => `
                                <div class="deliverable-item">
                                    <div class="deliverable-name">${deliverable.name}</div>
                                    <div class="deliverable-project">${deliverable.project}</div>
                                    <div class="deliverable-due-date">Due: ${new Date(deliverable.due_date).toLocaleDateString()}</div>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No upcoming deliverables</div>'
                        }
                    </div>
                `;
                
                // Metrics Card
                const metricsCard = document.createElement('div');
                metricsCard.className = 'dashboard-card';
                metricsCard.innerHTML = `
                    <h3>Agency Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-label">Utilization Rate</div>
                            <div class="metric-value">${data.metrics && data.metrics.utilization_rate ? data.metrics.utilization_rate.toFixed(1) + '%' : '—'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Project Completion Rate</div>
                            <div class="metric-value">${data.metrics && data.metrics.completion_rate ? data.metrics.completion_rate.toFixed(1) + '%' : '—'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Client Satisfaction</div>
                            <div class="metric-value">${data.metrics && data.metrics.client_satisfaction ? data.metrics.client_satisfaction.toFixed(1) + '/10' : '—'}</div>
                        </div>
                    </div>
                `;
                
                dashboardGrid.appendChild(projectsCard);
                dashboardGrid.appendChild(deliverablesCard);
                dashboardGrid.appendChild(metricsCard);
                container.appendChild(dashboardGrid);
            },
            
            renderShopifyModule(data, container) {
                const dashboardGrid = document.createElement('div');
                dashboardGrid.className = 'dashboard-grid';
                
                // Store Overview Card
                const overviewCard = document.createElement('div');
                overviewCard.className = 'dashboard-card';
                overviewCard.innerHTML = `
                    <h3>Store Overview</h3>
                    <div class="store-overview">
                        <div class="store-name">${data.store_name || 'Crooks & Castles'}</div>
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-label">Total Products</div>
                                <div class="metric-value">${data.total_products || '—'}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Total Orders</div>
                                <div class="metric-value">${data.total_orders || '—'}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Total Customers</div>
                                <div class="metric-value">${data.total_customers || '—'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Revenue Card
                const revenueCard = document.createElement('div');
                revenueCard.className = 'dashboard-card';
                revenueCard.innerHTML = `
                    <h3>Revenue</h3>
                    <div class="revenue-summary">
                        <div class="metric">
                            <div class="metric-label">Total Revenue</div>
                            <div class="metric-value">$${data.revenue && data.revenue.total ? data.revenue.total.toLocaleString() : '—'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Average Order Value</div>
                            <div class="metric-value">$${data.revenue && data.revenue.average_order_value ? data.revenue.average_order_value.toLocaleString() : '—'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Growth</div>
                            <div class="metric-value">${data.revenue && data.revenue.growth ? (data.revenue.growth > 0 ? '+' : '') + data.revenue.growth.toFixed(1) + '%' : '—'}</div>
                        </div>
                    </div>
                `;
                
                // Top Products Card
                const productsCard = document.createElement('div');
                productsCard.className = 'dashboard-card';
                productsCard.innerHTML = `
                    <h3>Top Products</h3>
                    <div class="products-list">
                        ${data.top_products && data.top_products.length > 0 ? 
                            data.top_products.map(product => `
                                <div class="product-item">
                                    <div class="product-title">${product.title}</div>
                                    <div class="product-price">$${product.price}</div>
                                    <div class="product-inventory">Inventory: ${product.inventory_quantity}</div>
                                </div>
                            `).join('') : 
                            '<div class="no-data">No product data available</div>'
                        }
                    </div>
                `;
                
                dashboardGrid.appendChild(overviewCard);
                dashboardGrid.appendChild(revenueCard);
                dashboardGrid.appendChild(productsCard);
                container.appendChild(dashboardGrid);
            },
            
            renderGenericModule(data, container) {
                // For modules without specific rendering, display formatted JSON
                const jsonContainer = document.createElement('div');
                jsonContainer.className = 'json-container';
                jsonContainer.innerHTML = `<pre>${formatJSON(data)}</pre>`;
                container.appendChild(jsonContainer);
            }
        };
        
        // Intelligence Integration Layer
        const IntelligenceLayer = (function() {
            // Private data store
            let _moduleData = {};
            let _recommendations = [];
            let _initialized = false;
            
            /**
             * Initialize the intelligence layer
             * @returns {Promise} Promise that resolves when initialization is complete
             */
            async function initialize() {
                if (_initialized) return Promise.resolve();
                
                try {
                    // Fetch data from all modules
                    const modules = ['intelligence', 'executive', 'content', 'agency', 'shopify'];
                    const promises = modules.map(module => fetchModuleData(module));
                    
                    // Wait for all data to be fetched
                    await Promise.all(promises);
                    
                    // Generate cross-module recommendations
                    generateRecommendations();
                    
                    // Show recommendations section
                    document.getElementById('intelligence-recommendations').style.display = 'block';
                    
                    // Render recommendations
                    renderRecommendations();
                    
                    _initialized = true;
                    return Promise.resolve();
                } catch (error) {
                    console.error('Error initializing intelligence layer:', error);
                    return Promise.reject(error);
                }
            }
            
            /**
             * Fetch data for a specific module
             * @param {string} module - Module name
             * @returns {Promise} Promise that resolves when data is fetched
             */
            async function fetchModuleData(module) {
                try {
                    // Map module names to API endpoints
                    const endpoints = {
                        'executive': 'executive/overview',
                        'intelligence': 'intelligence/dashboard',
                        'content': 'content/dashboard',
                        'agency': 'agency/dashboard',
                        'shopify': 'shopify'
                    };
                    
                    const endpoint = endpoints[module];
                    if (!endpoint) return;
                    
                    const data = await APIClient.get(endpoint);
                    _moduleData[module] = data;
                } catch (error) {
                    console.error(`Error fetching ${module} data:`, error);
                }
            }
            
            /**
             * Generate cross-module recommendations
             */
            function generateRecommendations() {
                // Initialize the recommendation engine with all module data
                if (window.RecommendationEngine) {
                    _recommendations = window.RecommendationEngine.initialize(_moduleData);
                } else {
                    // Fallback if recommendation engine is not loaded
                    _recommendations = generateFallbackRecommendations();
                }
            }
            
            /**
             * Generate fallback recommendations if the recommendation engine is not available
             * @returns {Array} Generated recommendations
             */
            function generateFallbackRecommendations() {
                const recommendations = [];
                
                // Add intelligence-based recommendations
                if (_moduleData.intelligence) {
                    if (_moduleData.intelligence.trends && _moduleData.intelligence.trends.length > 0) {
                        const trend = _moduleData.intelligence.trends[0];
                        recommendations.push({
                            title: `Leverage Trend: ${trend.name}`,
                            description: `Develop strategy to capitalize on identified trend with opportunity score of ${trend.opportunity_score}.`,
                            priority: 'high',
                            source: 'intelligence',
                            modules: ['intelligence', 'executive']
                        });
                    }
                    
                    if (_moduleData.intelligence.competitors_count) {
                        recommendations.push({
                            title: 'Competitive Analysis',
                            description: `Review competitive landscape with ${_moduleData.intelligence.competitors_count} tracked competitors.`,
                            priority: 'medium',
                            source: 'intelligence',
                            modules: ['intelligence', 'executive']
                        });
                    }
                }
                
                // Add shopify-based recommendations
                if (_moduleData.shopify && _moduleData.shopify.revenue) {
                    const growth = _moduleData.shopify.revenue.growth;
                    if (growth !== undefined) {
                        if (growth < 0) {
                            recommendations.push({
                                title: 'Address Revenue Decline',
                                description: `Develop strategy to address ${Math.abs(growth).toFixed(1)}% revenue decline.`,
                                priority: 'high',
                                source: 'shopify',
                                modules: ['shopify', 'executive', 'content']
                            });
                        } else if (growth > 10) {
                            recommendations.push({
                                title: 'Capitalize on Growth',
                                description: `Leverage ${growth.toFixed(1)}% revenue growth with expanded inventory and marketing.`,
                                priority: 'medium',
                                source: 'shopify',
                                modules: ['shopify', 'executive']
                            });
                        }
                    }
                }
                
                // Add agency-based recommendations
                if (_moduleData.agency && _moduleData.agency.projects) {
                    const projects = _moduleData.agency.projects;
                    const behindSchedule = projects.filter(p => p.progress < 50 && new Date(p.end_date) < new Date(new Date().getTime() + 14 * 24 * 60 * 60 * 1000));
                    
                    if (behindSchedule.length > 0) {
                        recommendations.push({
                            title: 'Project Timeline Alert',
                            description: `${behindSchedule.length} projects are behind schedule and approaching deadlines.`,
                            priority: 'high',
                            source: 'agency',
                            modules: ['agency', 'executive']
                        });
                    }
                }
                
                return recommendations;
            }
            
            /**
             * Render recommendations in the UI
             */
            function renderRecommendations() {
                const container = document.getElementById('recommendations-container');
                if (!container) return;
                
                // Clear loading state
                container.innerHTML = '';
                
                if (_recommendations.length === 0) {
                    container.innerHTML = '<div class="no-data">No recommendations available</div>';
                    return;
                }
                
                // Render each recommendation
                _recommendations.forEach(rec => {
                    const item = document.createElement('div');
                    item.className = `recommendation-item recommendation-priority-${rec.priority}`;
                    
                    item.innerHTML = `
                        <div class="recommendation-title">${rec.title}</div>
                        <div class="recommendation-description">${rec.description}</div>
                        <div class="recommendation-source">Source: ${rec.source} | Priority: ${rec.priority}</div>
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            /**
             * Get data for a specific module
             * @param {string} module - Module name
             * @returns {Object} Module data
             */
            function getModuleData(module) {
                return _moduleData[module];
            }
            
            /**
             * Get all recommendations
             * @returns {Array} All recommendations
             */
            function getRecommendations() {
                return _recommendations;
            }
            
            /**
             * Get recommendations for a specific module
             * @param {string} module - Module name
             * @returns {Array} Module-specific recommendations
             */
            function getRecommendationsForModule(module) {
                return _recommendations.filter(rec => 
                    !rec.modules || rec.modules.includes(module)
                );
            }
            
            // Public API
            return {
                initialize,
                getModuleData,
                getRecommendations,
                getRecommendationsForModule
            };
        })();
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Module navigation
            const moduleLinks = document.querySelectorAll('[data-module]');
            moduleLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const module = this.getAttribute('data-module');
                    ModuleLoader.loadModule(module);
                });
            });
            
            // Initialize the intelligence layer
            IntelligenceLayer.initialize().then(() => {
                console.log('Intelligence integration complete');
            }).catch(error => {
                console.error('Intelligence initialization error:', error);
            });
        });
    </script>
    
    <!-- Intelligence Integration Layer -->
    <script src="/static/js/INTELLIGENCE_INTEGRATION_LAYER.js"></script>
    <script src="/static/js/CROSS_MODULE_RECOMMENDATION_ENGINE.js"></script>
</body>
</html>
