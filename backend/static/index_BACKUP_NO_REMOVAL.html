<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crooks & Castles Command Center V2</title>
    <style>
        /* Custom Crooks & Castles Styles */
        :root {
            --crooks-black: #0a0a0a;
            --crooks-orange: #ff6b35;
            --crooks-gold: #ffd700;
            --crooks-gray: #1a1a1a;
        }
        
        body {
            background-color: var(--crooks-black);
            color: white;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .header {
            background-color: var(--crooks-gray);
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
            padding: 1rem 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--crooks-orange);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-checking { background-color: #6b7280; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .nav {
            background-color: var(--crooks-gray);
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #9ca3af;
        }
        
        .tab-button:hover {
            color: white;
        }
        
        .tab-button.tab-active {
            background-color: var(--crooks-black);
            color: var(--crooks-orange);
            border-bottom: 2px solid var(--crooks-orange);
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background-color: var(--crooks-gray);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--crooks-orange);
            margin-bottom: 1rem;
        }
        
        .grid {
            display: grid;
            gap: 1.5rem;
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--crooks-orange);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #e55a2b;
        }
        
        .btn-secondary {
            background-color: #374151;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #374151;
            border-radius: 0.375rem;
            background-color: var(--crooks-black);
            color: white;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--crooks-orange);
        }
        
        .textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #374151;
            border-radius: 0.375rem;
            background-color: var(--crooks-black);
            color: white;
            resize: vertical;
            min-height: 100px;
        }
        
        .textarea:focus {
            outline: none;
            border-color: var(--crooks-orange);
        }
        
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-gray-400 {
            color: #9ca3af;
        }
        
        .py-8 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--crooks-gray) 0%, #2d2d2d 100%);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--crooks-orange);
        }
        
        .metric-label {
            color: #9ca3af;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">Crooks & Castles Command Center V2</h1>
                <div class="status-indicator" id="shopifyStatus">
                    <div class="status-dot status-checking"></div>
                    <span>Checking status...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="container">
            <div class="nav-tabs">
                <button onclick="showTab('overview')" id="tab-overview" class="tab-button tab-active">
                    üìä Executive Overview
                </button>
                <button onclick="showTab('ingest')" id="tab-ingest" class="tab-button">
                    üì• Data Ingest
                </button>
                <button onclick="showTab('revenue')" id="tab-revenue" class="tab-button">
                    üí∞ Revenue Intelligence
                </button>
                <button onclick="showTab('shopify-setup')" id="tab-shopify-setup" class="tab-button">
                    üõí Shopify Setup
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- Alert for messages -->
            <div id="alertMessage" class="alert alert-success hidden"></div>

            <!-- Executive Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <div class="grid grid-cols-4">
                    <div class="metric-card">
                        <div class="metric-value" id="totalPosts">Loading...</div>
                        <div class="metric-label">Total Posts Analyzed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgEngagement">Loading...</div>
                        <div class="metric-label">Avg Engagement Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalFiles">Loading...</div>
                        <div class="metric-label">Data Files Processed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="lastUpdated">Loading...</div>
                        <div class="metric-label">Last Updated</div>
                    </div>
                </div>

                <div class="grid grid-cols-2">
                    <div class="card">
                        <h3 class="card-title">üéØ Top Performing Content</h3>
                        <div id="topContent">
                            <div class="text-center text-gray-400 py-8">Loading top content...</div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">üìä Data Status</h3>
                        <div id="dataStatus">
                            <div class="text-center text-gray-400 py-8">Loading data status...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Ingest Tab -->
            <div id="ingest-tab" class="tab-content">
                <div class="grid grid-cols-2">
                    <div class="card">
                        <h3 class="card-title">üìÅ File Upload</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="file" id="fileUpload" accept=".json,.jsonl,.csv" class="input">
                        </div>
                        <button onclick="processUploadedFile()" class="btn btn-primary">
                            üöÄ Process File
                        </button>
                        <div style="margin-top: 1rem; font-size: 0.875rem; color: #9ca3af;">
                            Supported formats: JSONL, JSON, CSV<br>
                            Expected fields: id, title, likes, shares, engagement_rate, platform
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">üìã JSON Paste</h3>
                        <textarea id="jsonPasteArea" placeholder="Paste JSON data here..." class="textarea" style="height: 150px;"></textarea>
                        <button onclick="processJsonPaste()" class="btn btn-primary" style="margin-top: 1rem;">
                            üöÄ Process JSON
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">üìä Processing Status</h3>
                    <div id="processingStatus">
                        <div class="text-center text-gray-400 py-8">Ready to process files</div>
                    </div>
                </div>
            </div>

            <!-- Revenue Intelligence Tab -->
            <div id="revenue-tab" class="tab-content">
                <div class="card">
                    <h3 class="card-title">üí∞ Revenue Intelligence Dashboard</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button onclick="syncShopifyData('sales')" class="btn btn-primary btn-small">
                            üí∞ Sync Sales
                        </button>
                        <button onclick="syncShopifyData('traffic')" class="btn btn-primary btn-small">
                            üìä Sync Traffic
                        </button>
                        <button onclick="syncShopifyData('products')" class="btn btn-primary btn-small">
                            üõçÔ∏è Sync Products
                        </button>
                    </div>
                    <div id="revenueStatus">
                        <div class="text-center text-gray-400 py-8">Connect Shopify to view revenue data</div>
                    </div>
                </div>
            </div>

            <!-- Shopify Setup Tab -->
            <div id="shopify-setup-tab" class="tab-content">
                <div class="card">
                    <h3 class="card-title">üõí Shopify Integration Setup</h3>
                    <div class="grid grid-cols-2">
                        <div>
                            <label for="shopUrl" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Shop Domain:</label>
                            <input type="text" id="shopUrl" placeholder="crooksonline (just the shop name)" class="input" style="margin-bottom: 1rem;">
                            
                            <label for="accessToken" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Access Token:</label>
                            <input type="password" id="accessToken" placeholder="Your private app access token" class="input" style="margin-bottom: 1rem;">
                            
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="testShopifyConnection()" class="btn btn-secondary">
                                    üîç Test Connection
                                </button>
                                <button onclick="saveShopifyConfig()" class="btn btn-primary">
                                    üíæ Save Configuration
                                </button>
                            </div>
                        </div>
                        <div>
                            <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">Setup Instructions:</h4>
                            <ol style="color: #9ca3af; line-height: 1.6;">
                                <li>Go to your Shopify admin panel</li>
                                <li>Navigate to Apps ‚Üí App and sales channel settings</li>
                                <li>Click "Develop apps" ‚Üí "Create an app"</li>
                                <li>Configure API scopes (read_orders, read_products, read_analytics)</li>
                                <li>Generate access token and copy it here</li>
                                <li>Enter just your shop name (e.g., "crooksonline")</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'overview';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Crooks & Castles Command Center V2 - Starting...');
            loadOverviewData();
            checkShopifyStatus();
        });

        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertDiv.classList.add('hidden');
            }, 5000);
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            
            currentTab = tabName;
            
            // Load data for specific tabs
            if (tabName === 'overview') {
                loadOverviewData();
            }
        }

        // FIXED: Load overview data from the correct endpoint with error handling
        async function loadOverviewData() {
            try {
                console.log('üìä Loading overview data from /ingest/overview...');
                
                const response = await fetch('/ingest/overview');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Overview data loaded:', data);

                if (data.success && data.data_available) {
                    // Update metrics with REAL data
                    document.getElementById('totalPosts').textContent = data.overview.total_posts || 0;
                    document.getElementById('avgEngagement').textContent = (data.overview.avg_engagement || 0) + '%';
                    document.getElementById('totalFiles').textContent = data.overview.total_files || 0;
                    
                    // Format last updated time
                    const lastUpdated = new Date(data.overview.last_updated).toLocaleString();
                    document.getElementById('lastUpdated').textContent = lastUpdated;
                    
                    // Display top performing content with REAL data
                    displayTopContent(data.top_content || []);
                    
                    // Display data status
                    displayDataStatus(data.overview, data.debug_info);
                    
                } else {
                    // Show when no data is available
                    document.getElementById('totalPosts').textContent = '0';
                    document.getElementById('avgEngagement').textContent = '0%';
                    document.getElementById('totalFiles').textContent = '0';
                    document.getElementById('lastUpdated').textContent = 'Never';
                    
                    document.getElementById('topContent').innerHTML = 
                        '<div class="text-center text-gray-400 py-8">üì§ Upload JSONL files to see your top performing content</div>';
                    
                    document.getElementById('dataStatus').innerHTML = 
                        '<div class="text-center text-gray-400 py-8">üìÅ No data files processed yet</div>';
                }
                
            } catch (error) {
                console.error('‚ùå Error loading overview data:', error);
                
                // Show error state
                document.getElementById('totalPosts').textContent = 'Error';
                document.getElementById('avgEngagement').textContent = 'Error';
                document.getElementById('totalFiles').textContent = 'Error';
                document.getElementById('lastUpdated').textContent = 'Error';
                
                document.getElementById('topContent').innerHTML = 
                    '<div class="text-center text-gray-400 py-8">‚ùå Error loading data. Please check server connection.</div>';
                
                document.getElementById('dataStatus').innerHTML = 
                    '<div class="text-center text-gray-400 py-8">‚ùå Error: ' + error.message + '</div>';
            }
        }

        function displayTopContent(topContent) {
            const element = document.getElementById('topContent');
            
            if (!topContent || topContent.length === 0) {
                element.innerHTML = '<div class="text-center text-gray-400 py-8">üì§ Upload JSONL files to see top content</div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            // Remove duplicates and get top 5
            const uniqueContent = topContent.filter((item, index, self) => 
                index === self.findIndex(t => t.id === item.id && t.title === item.title)
            ).slice(0, 5);
            
            uniqueContent.forEach((item, index) => {
                const likes = item.likes || 0;
                const shares = item.shares || 0;
                const engagement = likes + shares;
                const platform = item.platform || 'unknown';
                
                html += `
                    <div style="padding: 0.75rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.375rem; border-left: 3px solid var(--crooks-orange);">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">#${index + 1} ${item.title || 'Content Item'}</div>
                        <div style="font-size: 0.875rem; color: #9ca3af;">
                            üì± ${platform} ‚Ä¢ üëç ${likes} likes ‚Ä¢ üîÑ ${shares} shares ‚Ä¢ üìä ${item.engagement_rate || 0}% engagement
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            element.innerHTML = html;
        }

        function displayDataStatus(overview, debugInfo) {
            const element = document.getElementById('dataStatus');
            
            const html = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.375rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--crooks-orange);">${overview.total_files || 0}</div>
                            <div style="font-size: 0.875rem; color: #9ca3af;">Files Processed</div>
                        </div>
                        <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.375rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--crooks-orange);">${debugInfo?.total_records || overview.total_posts || 0}</div>
                            <div style="font-size: 0.875rem; color: #9ca3af;">Total Records</div>
                        </div>
                    </div>
                    <div style="padding: 1rem; background-color: rgba(16, 185, 129, 0.1); border-radius: 0.375rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: #10b981;">‚úÖ System Status</div>
                        <div style="font-size: 0.875rem; color: #9ca3af;">
                            Data processing: Active<br>
                            Last update: ${new Date(overview.last_updated).toLocaleString()}<br>
                            Engagement calculation: ${debugInfo?.engagement_records || 0} records processed
                        </div>
                    </div>
                </div>
            `;
            
            element.innerHTML = html;
        }

        // FIXED: File upload with proper error handling and success feedback
        async function processUploadedFile() {
            const fileInput = document.getElementById('fileUpload');
            const files = fileInput.files;

            if (!files || files.length === 0) {
                showAlert('Please select a file first', 'error');
                return;
            }

            const file = files[0];
            
            try {
                console.log(`üì§ Uploading file: ${file.name}`);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('source', 'frontend_upload');

                // Update processing status
                document.getElementById('processingStatus').innerHTML = `
                    <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.375rem;">
                        <div style="font-weight: 600; color: var(--crooks-orange);">üîÑ Processing ${file.name}...</div>
                        <div style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.5rem;">
                            File size: ${(file.size / 1024).toFixed(1)} KB
                        </div>
                    </div>
                `;

                const response = await fetch('/ingest/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Upload result:', data);

                if (data.success) {
                    showAlert(`‚úÖ File "${file.name}" uploaded successfully! Processed ${data.records_processed} records.`, 'success');
                    
                    // Update processing status with success
                    document.getElementById('processingStatus').innerHTML = `
                        <div style="padding: 1rem; background-color: rgba(16, 185, 129, 0.1); border-radius: 0.375rem;">
                            <div style="font-weight: 600; color: #10b981;">‚úÖ ${file.name} processed successfully</div>
                            <div style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.5rem;">
                                Records: ${data.records_processed} ‚Ä¢ Columns: ${data.columns?.join(', ') || 'N/A'}<br>
                                Saved to: ${data.metadata?.file_path || 'Unknown location'}
                            </div>
                        </div>
                    `;
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    // Refresh overview data to show the new data
                    setTimeout(() => {
                        loadOverviewData();
                    }, 1000);
                    
                } else {
                    throw new Error(data.error || 'Upload failed');
                }

            } catch (error) {
                console.error('‚ùå Error uploading file:', error);
                showAlert(`‚ùå Failed to upload "${file.name}": ${error.message}`, 'error');
                
                // Update processing status with error
                document.getElementById('processingStatus').innerHTML = `
                    <div style="padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border-radius: 0.375rem;">
                        <div style="font-weight: 600; color: #ef4444;">‚ùå Upload failed</div>
                        <div style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.5rem;">
                            Error: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        async function processJsonPaste() {
            const textarea = document.getElementById('jsonPasteArea');
            const jsonData = textarea.value.trim();

            if (!jsonData) {
                showAlert('Please paste JSON data first', 'error');
                return;
            }

            try {
                console.log('üìã Processing pasted JSON data...');
                
                const parsedData = JSON.parse(jsonData);
                
                const response = await fetch('/ingest/paste', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parsedData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Paste processing result:', data);

                if (data.success) {
                    showAlert('‚úÖ JSON data processed successfully!', 'success');
                    textarea.value = '';
                    
                    // Refresh data
                    setTimeout(() => {
                        loadOverviewData();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Processing failed');
                }

            } catch (error) {
                console.error('‚ùå Error processing JSON paste:', error);
                showAlert(`‚ùå Failed to process JSON data: ${error.message}`, 'error');
            }
        }

        async function checkShopifyStatus() {
            try {
                const response = await fetch('/shopify/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('shopifyStatus');
                const statusDot = statusElement.querySelector('.status-dot');
                const statusText = statusElement.querySelector('span');
                
                if (data.connected) {
                    statusDot.className = 'status-dot status-online';
                    statusText.textContent = 'Shopify: Connected';
                } else {
                    statusDot.className = 'status-dot status-offline';
                    statusText.textContent = 'Shopify: Not Connected';
                }
                
            } catch (error) {
                console.error('Error checking Shopify status:', error);
                const statusElement = document.getElementById('shopifyStatus');
                const statusDot = statusElement.querySelector('.status-dot');
                const statusText = statusElement.querySelector('span');
                statusDot.className = 'status-dot status-offline';
                statusText.textContent = 'Shopify: Error';
            }
        }

        async function testShopifyConnection() {
            const shopUrl = document.getElementById('shopUrl').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!shopUrl || !accessToken) {
                showAlert('Please enter both shop URL and access token', 'error');
                return;
            }

            try {
                console.log('üîç Testing Shopify connection...');
                
                const formData = new FormData();
                formData.append('shop_domain', shopUrl);
                formData.append('access_token', accessToken);

                const response = await fetch('/shopify/setup', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log('Connection test result:', data);

                if (data.success) {
                    showAlert('‚úÖ Connection successful! You can now save the configuration.', 'success');
                } else {
                    showAlert('‚ùå Connection failed: ' + (data.detail || data.error || 'Unknown error'), 'error');
                }

            } catch (error) {
                console.error('Connection test error:', error);
                showAlert(`‚ùå Connection test failed: ${error.message}`, 'error');
            }
        }

        async function saveShopifyConfig() {
            const shopUrl = document.getElementById('shopUrl').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!shopUrl || !accessToken) {
                showAlert('Please enter both shop URL and access token', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('shop_domain', shopUrl);
                formData.append('access_token', accessToken);

                const response = await fetch('/shopify/setup', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ Shopify configuration saved successfully!', 'success');
                    checkShopifyStatus();
                } else {
                    throw new Error(data.error || 'Setup failed');
                }

            } catch (error) {
                console.error('Error saving Shopify config:', error);
                showAlert(`‚ùå Failed to save configuration: ${error.message}`, 'error');
            }
        }

        // FIXED: Sync Shopify data with proper error handling
        async function syncShopifyData(type) {
            try {
                console.log(`üí∞ Syncing Shopify ${type} data...`);
                
                let requestBody = {};
                
                if (type === 'sales' || type === 'traffic') {
                    requestBody = {
                        days_back: 30,
                        include_correlation: true
                    };
                }

                const response = await fetch(`/shopify/sync/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`${type} sync result:`, data);

                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                } else {
                    throw new Error(data.error || `${type} sync failed`);
                }

            } catch (error) {
                console.error(`‚ùå Error syncing ${type} data:`, error);
                showAlert(`‚ùå Failed to sync ${type} data: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
