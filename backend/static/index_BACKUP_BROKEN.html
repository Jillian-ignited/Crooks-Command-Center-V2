<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crooks & Castles Command Center V2</title>
    <style>
        /* Tailwind CSS Reset and Base Styles */
        *, ::before, ::after {
            box-sizing: border-box;
            border-width: 0;
            border-style: solid;
            border-color: #e5e7eb;
        }
        
        html {
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -moz-tab-size: 4;
            tab-size: 4;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        
        body {
            margin: 0;
            line-height: inherit;
        }
        
        /* Custom Crooks & Castles Styles */
        :root {
            --crooks-black: #0a0a0a;
            --crooks-orange: #ff6b35;
            --crooks-gold: #ffd700;
            --crooks-gray: #1a1a1a;
        }
        
        body {
            background-color: var(--crooks-black);
            color: white;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .header {
            background-color: var(--crooks-gray);
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
            padding: 1rem 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--crooks-orange);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-checking { background-color: #6b7280; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .nav {
            background-color: var(--crooks-gray);
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #9ca3af;
        }
        
        .tab-button:hover {
            color: white;
        }
        
        .tab-button.tab-active {
            background-color: var(--crooks-black);
            color: var(--crooks-orange);
            border-bottom: 2px solid var(--crooks-orange);
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background-color: var(--crooks-gray);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--crooks-orange);
            margin-bottom: 1rem;
        }
        
        .grid {
            display: grid;
            gap: 1.5rem;
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .grid-cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--crooks-orange);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #e55a2b;
        }
        
        .btn-secondary {
            background-color: #374151;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #374151;
            border-radius: 0.375rem;
            background-color: var(--crooks-black);
            color: white;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--crooks-orange);
        }
        
        .textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #374151;
            border-radius: 0.375rem;
            background-color: var(--crooks-black);
            color: white;
            resize: vertical;
            min-height: 100px;
        }
        
        .textarea:focus {
            outline: none;
            border-color: var(--crooks-orange);
        }
        
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-gray-400 {
            color: #9ca3af;
        }
        
        .py-8 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: linear-gradient(135deg, var(--crooks-gray) 0%, #2d2d2d 100%);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--crooks-orange);
        }
        
        .metric-label {
            color: #9ca3af;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #374151;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--crooks-orange);
            transition: width 0.3s ease;
        }
        
        /* Calendar Specific Styles */
        .calendar-view-content {
            display: none;
        }
        
        .calendar-view-content.active {
            display: block;
        }
        
        .calendar-container {
            background-color: var(--crooks-gray);
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }
        
        .calendar-nav-btn {
            background: none;
            border: none;
            color: var(--crooks-orange);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .calendar-nav-btn:hover {
            color: #e55a2b;
        }
        
        .calendar-month-year {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #374151;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        .calendar-day-header {
            background-color: var(--crooks-gray);
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--crooks-orange);
        }
        
        .calendar-day {
            background-color: var(--crooks-black);
            padding: 0.75rem 0.5rem;
            min-height: 80px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .calendar-day:hover {
            background-color: var(--crooks-gray);
        }
        
        .calendar-day.other-month {
            color: #6b7280;
        }
        
        .calendar-day.today {
            background-color: rgba(255, 107, 53, 0.2);
            border: 1px solid var(--crooks-orange);
        }
        
        .calendar-day.has-event {
            border-left: 3px solid var(--crooks-orange);
        }
        
        .calendar-event {
            background-color: rgba(255, 107, 53, 0.3);
            border-radius: 0.25rem;
            padding: 0.25rem;
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: white;
        }
        
        /* Media Library Styles */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .media-item {
            background-color: var(--crooks-gray);
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }
        
        .media-preview {
            width: 100%;
            height: 150px;
            background-color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }
        
        .media-info {
            padding: 1rem;
        }
        
        .media-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .media-meta {
            font-size: 0.875rem;
            color: #9ca3af;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">Crooks & Castles Command Center V2</h1>
                <div class="status-indicator" id="shopifyStatus">
                    <div class="status-dot status-checking"></div>
                    <span>Checking status...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="container">
            <div class="nav-tabs">
                <button onclick="showTab('overview')" id="tab-overview" class="tab-button tab-active">
                    📊 Executive Overview
                </button>
                <button onclick="showTab('intelligence')" id="tab-intelligence" class="tab-button">
                    🧠 Intelligence
                </button>
                <button onclick="showTab('revenue')" id="tab-revenue" class="tab-button">
                    💰 Revenue Intelligence
                </button>
                <button onclick="showTab('calendar')" id="tab-calendar" class="tab-button">
                    📅 Campaign Calendar
                </button>
                <button onclick="showTab('media')" id="tab-media" class="tab-button">
                    🎬 Media Library
                </button>
                <button onclick="showTab('ingest')" id="tab-ingest" class="tab-button">
                    📥 Data Ingest
                </button>
                <button onclick="showTab('shopify-setup')" id="tab-shopify-setup" class="tab-button">
                    🛒 Shopify Setup
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- Executive Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <div class="grid grid-cols-4">
                    <div class="metric-card">
                        <div class="metric-value" id="totalPosts">0</div>
                        <div class="metric-label">Total Posts Analyzed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgEngagement">0%</div>
                        <div class="metric-label">Avg Engagement Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="revenueImpact">$0</div>
                        <div class="metric-label">Revenue Impact</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="competitorInsights">0</div>
                        <div class="metric-label">Data Files Processed</div>
                    </div>
                </div>

                <div class="grid grid-cols-2">
                    <div class="card">
                        <h3 class="card-title">📈 Performance Trends</h3>
                        <div id="performanceTrends">
                            <div class="text-center text-gray-400 py-8">Upload JSONL files to view performance data</div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">🎯 Top Performing Content</h3>
                        <div id="topContent">
                            <div class="text-center text-gray-400 py-8">Upload JSONL files to view top content</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intelligence Tab -->
            <div id="intelligence-tab" class="tab-content">
                <div class="grid grid-cols-2">
                    <div class="card">
                        <h3 class="card-title">🔍 Competitor Analysis</h3>
                        <div id="competitorAnalysis">
                            <div class="text-center text-gray-400 py-8">Loading competitor data...</div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">📊 Market Insights</h3>
                        <div id="marketInsights">
                            <div class="text-center text-gray-400 py-8">Loading market insights...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">🎨 Content Strategy Recommendations</h3>
                    <div id="contentStrategy">
                        <div class="text-center text-gray-400 py-8">Loading strategy recommendations...</div>
                    </div>
                </div>
            </div>

            <!-- Revenue Intelligence Tab -->
            <div id="revenue-tab" class="tab-content">
                <div class="card mb-6">
                    <h3 class="card-title">💰 Revenue Intelligence Dashboard</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="syncShopifyData('sales')" class="btn btn-primary btn-small">
                            💰 Sync Sales
                        </button>
                        <button onclick="syncShopifyData('traffic')" class="btn btn-primary btn-small">
                            📊 Sync Traffic
                        </button>
                        <button onclick="syncShopifyData('products')" class="btn btn-primary btn-small">
                            🛍️ Sync Products
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2">
                    <div class="card">
                        <h3 class="card-title">📈 Sales Performance</h3>
                        <div id="salesPerformance">
                            <div class="text-center text-gray-400 py-8">Connect Shopify to view sales data</div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">🔗 Social-Commerce Correlation</h3>
                        <div id="socialCorrelation">
                            <div class="text-center text-gray-400 py-8">Connect Shopify to view correlations</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaign Calendar Tab -->
            <div id="calendar-tab" class="tab-content">
                <!-- Strategic Calendar Views -->
                <div class="card mb-6">
                    <h3 class="card-title">📊 Strategic Calendar Views</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="switchCalendarView('tactical7')" id="view-tactical7" class="btn btn-secondary btn-small">
                            📅 7-Day Tactical
                        </button>
                        <button onclick="switchCalendarView('strategic30')" id="view-strategic30" class="btn btn-secondary btn-small">
                            🎯 30-Day Strategic  
                        </button>
                        <button onclick="switchCalendarView('strategic60')" id="view-strategic60" class="btn btn-secondary btn-small">
                            🌟 60-Day Planning
                        </button>
                        <button onclick="switchCalendarView('strategic90')" id="view-strategic90" class="btn btn-secondary btn-small">
                            🚀 90+ Long-term
                        </button>
                        <button onclick="openQuarterlyStrategy()" class="btn btn-primary btn-small">
                            📋 Quarterly Strategy
                        </button>
                    </div>
                </div>

                <!-- Content Creation Tools -->
                <div class="card mb-6">
                    <h3 class="card-title">🎨 Content Creation Tools</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="generateCampaign()" class="btn btn-primary btn-small">
                            🎯 Campaign Generator
                        </button>
                        <button onclick="analyzeTrends()" class="btn btn-primary btn-small">
                            📈 Trend Analysis
                        </button>
                        <button onclick="createContentCalendar()" class="btn btn-primary btn-small">
                            📅 Content Calendar Creator
                        </button>
                        <button onclick="planCulturalMoments()" class="btn btn-primary btn-small">
                            🌍 Cultural Moment Planner
                        </button>
                    </div>
                </div>

                <!-- 7-Day Tactical View -->
                <div id="tactical7-view" class="calendar-view-content active">
                    <div class="grid grid-cols-2">
                        <div class="card">
                            <h3 class="card-title">📋 Weekly Content Pipeline</h3>
                            <div id="weeklyPipeline">
                                <div class="text-center text-gray-400 py-8">Loading weekly content...</div>
                            </div>
                        </div>
                        <div class="card">
                            <h3 class="card-title">🎬 Asset Mapping</h3>
                            <div id="assetMapping">
                                <div class="text-center text-gray-400 py-8">Loading asset assignments...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 30-Day Strategic View -->
                <div id="strategic30-view" class="calendar-view-content">
                    <div class="grid grid-cols-2">
                        <div class="card">
                            <h3 class="card-title">✅ Approved Content</h3>
                            <div id="approvedContent">
                                <div class="text-center text-gray-400 py-8">Loading approved content...</div>
                            </div>
                        </div>
                        <div class="card">
                            <h3 class="card-title">💡 Opportunities</h3>
                            <div id="contentOpportunities">
                                <div class="text-center text-gray-400 py-8">Loading opportunities...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 60-Day Planning View -->
                <div id="strategic60-view" class="calendar-view-content">
                    <div class="card">
                        <h3 class="card-title">🌟 60-Day Content Strategy</h3>
                        <div id="longTermStrategy">
                            <div class="text-center text-gray-400 py-8">Loading long-term strategy...</div>
                        </div>
                    </div>
                </div>

                <!-- 90+ Long-term View -->
                <div id="strategic90-view" class="calendar-view-content">
                    <div class="card">
                        <h3 class="card-title">🚀 Long-term Planning</h3>
                        <div id="longTermPlanning">
                            <div class="text-center text-gray-400 py-8">Loading long-term planning...</div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Widget -->
                <div class="card">
                    <h3 class="card-title">📅 Campaign Calendar</h3>
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="calendar-nav-btn" onclick="previousMonth()">‹</button>
                            <div class="calendar-month-year" id="monthYear"></div>
                            <button class="calendar-nav-btn" onclick="nextMonth()">›</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Library Tab -->
            <div id="media-tab" class="tab-content">
                <div class="card mb-6">
                    <h3 class="card-title">🎬 Media Library Management</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="document.getElementById('mediaUpload').click()" class="btn btn-primary btn-small">
                            📤 Upload Media
                        </button>
                        <button onclick="loadAssetLibrary()" class="btn btn-secondary btn-small">
                            🔄 Refresh Library
                        </button>
                        <button onclick="organizeAssets()" class="btn btn-secondary btn-small">
                            📁 Organize Assets
                        </button>
                    </div>
                    <input type="file" id="mediaUpload" multiple accept="image/*,video/*,audio/*" style="display: none;" onchange="handleMediaUpload(event)">
                </div>

                <div class="card">
                    <h3 class="card-title">📁 Asset Library</h3>
                    <div id="assetLibrary" class="media-grid">
                        <div class="text-center text-gray-400 py-8">Loading media assets...</div>
                    </div>
                </div>
            </div>

            <!-- Data Ingest Tab -->
            <div id="ingest-tab" class="tab-content">
                <div class="grid grid-cols-2">
                    <div class="card">
                        <h3 class="card-title">📁 File Upload</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="file" id="fileUpload" accept=".json,.jsonl,.csv" onchange="handleFileUpload(event)" class="input">
                        </div>
                        <button onclick="processUploadedFile()" class="btn btn-primary">
                            🚀 Process File
                        </button>
                    </div>
                    <div class="card">
                        <h3 class="card-title">📋 JSON Paste</h3>
                        <textarea id="jsonPasteArea" placeholder="Paste JSON data here..." class="textarea" style="height: 150px;"></textarea>
                        <button onclick="processJsonPaste()" class="btn btn-primary" style="margin-top: 1rem;">
                            🚀 Process JSON
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">📊 Processing Status</h3>
                    <div id="processingStatus">
                        <div class="text-center text-gray-400 py-8">No processing activity</div>
                    </div>
                </div>
            </div>

            <!-- Shopify Setup Tab -->
            <div id="shopify-setup-tab" class="tab-content">
                <div class="card">
                    <h3 class="card-title">🛒 Shopify Integration Setup</h3>
                    <div class="grid grid-cols-2">
                        <div>
                            <label for="shopUrl" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Shop Domain:</label>
                            <input type="text" id="shopUrl" placeholder="crooksonline (just the shop name)" class="input" style="margin-bottom: 1rem;">
                            
                            <label for="accessToken" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Access Token:</label>
                            <input type="password" id="accessToken" placeholder="Your private app access token" class="input" style="margin-bottom: 1rem;">
                            
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="testShopifyConnection()" class="btn btn-secondary">
                                    🔍 Test Connection
                                </button>
                                <button onclick="saveShopifyConfig()" class="btn btn-primary">
                                    💾 Save Configuration
                                </button>
                            </div>
                        </div>
                        <div>
                            <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">Setup Instructions:</h4>
                            <ol style="color: #9ca3af; line-height: 1.6;">
                                <li>Go to your Shopify admin panel</li>
                                <li>Navigate to Apps → App and sales channel settings</li>
                                <li>Click "Develop apps" → "Create an app"</li>
                                <li>Configure API scopes (read_orders, read_products, read_analytics)</li>
                                <li>Generate access token and copy it here</li>
                                <li>Enter just your shop name (e.g., "crooksonline")</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'overview';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentCalendarView = 'tactical7';
        
        const dataLoaded = {
            overview: false,
            intelligence: false,
            revenue: false,
            media: false,
            calendar: false
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Crooks & Castles Command Center V2 - Initializing...');
            checkShopifyStatus();
            loadOverviewData();
            setupFileUpload();
            setupMediaFileUpload();
        });

        function setupFileUpload() {
            const fileInput = document.getElementById('fileUpload');
            fileInput.addEventListener('change', handleFileUpload);
        }

        function setupMediaFileUpload() {
            const mediaFileInput = document.getElementById('mediaFileInput');
            if (mediaFileInput) {
                mediaFileInput.addEventListener('change', handleMediaFileUpload);
            }
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                await uploadFile(file);
            }

            event.target.value = '';
        }

        async function handleMediaFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                await uploadMediaFile(file);
            }

            event.target.value = '';
        }

        async function handleMediaUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                await uploadMediaFile(file);
            }

            event.target.value = '';
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            
            currentTab = tabName;
            
            // Load data for the tab if not already loaded
            if (!dataLoaded[tabName]) {
                switch(tabName) {
                    case 'overview':
                        loadOverviewData();
                        break;
                    case 'intelligence':
                        loadIntelligenceData();
                        break;
                    case 'revenue':
                        loadRevenueIntelligence();
                        break;
                    case 'media':
                        loadMediaLibrary();
                        break;
                    case 'calendar':
                        loadCalendarData();
                        break;
                }
            }
        }

        // Calendar Functions
        function initializeCalendar() {
            renderCalendar();
            updateUpcomingEvents();
        }

        function loadCalendarData() {
            switchCalendarView('tactical7'); // Default to 7-day tactical view
            dataLoaded.calendar = true;
        }

        // Calendar View Switching
        function switchCalendarView(viewType) {
            currentCalendarView = viewType;
            
            // Hide all views
            document.querySelectorAll('.calendar-view-content').forEach(view => {
                view.classList.remove('active');
            });
            
            // Remove active class from all view buttons
            document.querySelectorAll('[id^="view-"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // Show selected view
            const selectedView = document.getElementById(viewType + '-view');
            if (selectedView) {
                selectedView.classList.add('active');
            }
            
            // Update button state
            const selectedButton = document.getElementById('view-' + viewType);
            if (selectedButton) {
                selectedButton.classList.remove('btn-secondary');
                selectedButton.classList.add('btn-primary');
            }
            
            // Load data for the specific view
            loadCalendarViewData(viewType);
        }

        function loadCalendarViewData(viewType) {
            switch(viewType) {
                case 'tactical7':
                    loadWeeklyPipeline();
                    loadAssetMapping();
                    break;
                case 'strategic30':
                    loadApprovedContent();
                    loadContentOpportunities();
                    break;
                case 'strategic60':
                    loadLongTermStrategy();
                    break;
                case 'strategic90':
                    loadLongTermPlanning();
                    break;
            }
        }

        // Content Creation Tool Functions
        async function generateCampaign() {
            try {
                console.log('Generating campaign...');
                const response = await fetch('/content-tools/generate-campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        brand: 'Crooks & Castles',
                        objectives: ['brand_awareness', 'engagement'],
                        duration: 30
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('Campaign generated successfully!');
                    console.log('Campaign data:', data);
                } else {
                    alert('Campaign generation is not yet implemented');
                }
            } catch (error) {
                console.error('Error generating campaign:', error);
                alert('Campaign generation feature coming soon!');
            }
        }

        async function analyzeTrends() {
            try {
                console.log('Analyzing trends...');
                alert('Trend analysis feature coming soon!');
            } catch (error) {
                console.error('Error analyzing trends:', error);
            }
        }

        async function createContentCalendar() {
            try {
                console.log('Creating content calendar...');
                alert('Content calendar creator coming soon!');
            } catch (error) {
                console.error('Error creating content calendar:', error);
            }
        }

        async function planCulturalMoments() {
            try {
                console.log('Planning cultural moments...');
                alert('Cultural moment planner coming soon!');
            } catch (error) {
                console.error('Error planning cultural moments:', error);
            }
        }

        async function openQuarterlyStrategy() {
            try {
                console.log('Opening quarterly strategy...');
                alert('Quarterly strategy planner coming soon!');
            } catch (error) {
                console.error('Error opening quarterly strategy:', error);
            }
        }

        // Calendar View Data Loading Functions
        async function loadWeeklyPipeline() {
            const element = document.getElementById('weeklyPipeline');
            element.innerHTML = `
                <div style="padding: 1rem;">
                    <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">This Week's Content Pipeline</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            <strong>Monday:</strong> Instagram Story - Behind the scenes
                        </div>
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            <strong>Wednesday:</strong> TikTok - New collection reveal
                        </div>
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            <strong>Friday:</strong> Instagram Post - Lifestyle shot
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadAssetMapping() {
            const element = document.getElementById('assetMapping');
            element.innerHTML = `
                <div style="padding: 1rem;">
                    <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">Asset Assignments</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            <strong>Video_001.mp4</strong> → Monday IG Story
                        </div>
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            <strong>Photo_Set_A</strong> → Wednesday TikTok
                        </div>
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            <strong>Lifestyle_001.jpg</strong> → Friday IG Post
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadApprovedContent() {
            const element = document.getElementById('approvedContent');
            element.innerHTML = `
                <div style="padding: 1rem;">
                    <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">Approved for Next 30 Days</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="padding: 0.5rem; background-color: rgba(16, 185, 129, 0.1); border-radius: 0.25rem;">
                            ✅ <strong>Holiday Campaign</strong> - Dec 15-25
                        </div>
                        <div style="padding: 0.5rem; background-color: rgba(16, 185, 129, 0.1); border-radius: 0.25rem;">
                            ✅ <strong>New Year Collection</strong> - Jan 1-15
                        </div>
                        <div style="padding: 0.5rem; background-color: rgba(255, 193, 7, 0.1); border-radius: 0.25rem;">
                            ⏳ <strong>Valentine's Day</strong> - Pending approval
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadContentOpportunities() {
            const element = document.getElementById('contentOpportunities');
            element.innerHTML = `
                <div style="padding: 1rem;">
                    <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">Content Opportunities</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            💡 <strong>Trending Audio</strong> - Hip-hop track gaining traction
                        </div>
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            💡 <strong>Competitor Gap</strong> - Streetwear styling content
                        </div>
                        <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                            💡 <strong>Cultural Moment</strong> - Fashion Week approaching
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadLongTermStrategy() {
            const element = document.getElementById('longTermStrategy');
            element.innerHTML = `
                <div style="padding: 1rem;">
                    <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">60-Day Strategic Initiatives</h4>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.5rem;">
                            <h5 style="margin: 0 0 0.5rem 0;">Q1 Brand Repositioning</h5>
                            <p style="margin: 0; color: #9ca3af;">Focus on heritage and authenticity messaging across all platforms</p>
                        </div>
                        <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.5rem;">
                            <h5 style="margin: 0 0 0.5rem 0;">Influencer Partnerships</h5>
                            <p style="margin: 0; color: #9ca3af;">Collaborate with 5 key streetwear influencers for authentic content</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadLongTermPlanning() {
            const element = document.getElementById('longTermPlanning');
            element.innerHTML = `
                <div style="padding: 1rem;">
                    <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">90+ Day Vision</h4>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.5rem;">
                            <h5 style="margin: 0 0 0.5rem 0;">Brand Evolution</h5>
                            <p style="margin: 0; color: #9ca3af;">Transition to more sustainable and socially conscious messaging</p>
                        </div>
                        <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.5rem;">
                            <h5 style="margin: 0 0 0.5rem 0;">Platform Expansion</h5>
                            <p style="margin: 0; color: #9ca3af;">Launch presence on emerging platforms and international markets</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCalendar() {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];

            const monthYear = document.getElementById('monthYear');
            monthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

            // Add previous month's trailing days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayDiv = createCalendarDay(day, true);
                calendarGrid.appendChild(dayDiv);
            }

            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = createCalendarDay(day, false);
                calendarGrid.appendChild(dayDiv);
            }

            // Add next month's leading days
            const totalCells = calendarGrid.children.length - 7; // Subtract day headers
            const remainingCells = 42 - totalCells; // 6 rows × 7 days = 42 cells
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = createCalendarDay(day, true);
                calendarGrid.appendChild(dayDiv);
            }
        }

        function createCalendarDay(day, isOtherMonth) {
            const dayDiv = document.createElement('div');
            dayDiv.className = `calendar-day ${isOtherMonth ? 'other-month' : ''}`;
            
            const today = new Date();
            if (!isOtherMonth && day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                dayDiv.classList.add('today');
            }

            dayDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.25rem;">${day}</div>
            `;

            // Add sample events for demonstration
            if (!isOtherMonth && (day === 15 || day === 22 || day === 28)) {
                dayDiv.classList.add('has-event');
                const event = document.createElement('div');
                event.className = 'calendar-event';
                event.textContent = day === 15 ? 'Campaign Launch' : day === 22 ? 'Content Review' : 'Strategy Meeting';
                dayDiv.appendChild(event);
            }

            return dayDiv;
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        // Initialize calendar when calendar tab is loaded
        document.addEventListener('DOMContentLoaded', function() {
            renderCalendar();
        });

        // FIXED: Load overview data from the correct endpoint
        async function loadOverviewData() {
            try {
                console.log('Loading overview data from ingest endpoint...');
                const response = await fetch('/ingest/overview');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Overview data loaded:', data);

                if (data.success && data.data_available) {
                    // Update metrics with real data
                    document.getElementById('totalPosts').textContent = data.overview.total_posts || 0;
                    document.getElementById('avgEngagement').textContent = data.overview.avg_engagement + '%' || '0%';
                    document.getElementById('competitorInsights').textContent = data.overview.total_files || 0;
                    
                    // Display top performing content
                    displayTopContent(data.top_content || []);
                    
                    // Display performance summary
                    displayPerformanceSummary(data.overview || {});
                    
                } else {
                    // Show default state when no data is available
                    document.getElementById('totalPosts').textContent = '0';
                    document.getElementById('avgEngagement').textContent = '0%';
                    document.getElementById('competitorInsights').textContent = '0';
                    
                    document.getElementById('performanceTrends').innerHTML = 
                        '<div class="text-center text-gray-400 py-8">Upload JSONL files to view performance data</div>';
                    document.getElementById('topContent').innerHTML = 
                        '<div class="text-center text-gray-400 py-8">Upload JSONL files to view top content</div>';
                }

                dataLoaded.overview = true;
                
            } catch (error) {
                console.error('Error loading overview data:', error);
                document.getElementById('performanceTrends').innerHTML = 
                    '<div class="text-center text-gray-400 py-8">Error loading data. Please try uploading JSONL files.</div>';
                document.getElementById('topContent').innerHTML = 
                    '<div class="text-center text-gray-400 py-8">Error loading data. Please try uploading JSONL files.</div>';
            }
        }

        function displayTopContent(topContent) {
            const element = document.getElementById('topContent');
            
            if (!topContent || topContent.length === 0) {
                element.innerHTML = '<div class="text-center text-gray-400 py-8">No top content data available</div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            topContent.slice(0, 5).forEach((item, index) => {
                const likes = item.likes || 0;
                const shares = item.shares || 0;
                const engagement = likes + shares;
                
                html += `
                    <div style="padding: 0.75rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.375rem; border-left: 3px solid var(--crooks-orange);">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">#${index + 1} ${item.title || item.text?.substring(0, 50) + '...' || 'Content Item'}</div>
                        <div style="font-size: 0.875rem; color: #9ca3af;">
                            👍 ${likes} likes • 🔄 ${shares} shares • Total: ${engagement}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            element.innerHTML = html;
        }

        function displayPerformanceSummary(summary) {
            const element = document.getElementById('performanceTrends');
            
            html = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.375rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--crooks-orange);">${summary.total_posts || 0}</div>
                            <div style="font-size: 0.875rem; color: #9ca3af;">Total Posts</div>
                        </div>
                        <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.375rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--crooks-orange);">${summary.avg_engagement || 0}%</div>
                            <div style="font-size: 0.875rem; color: #9ca3af;">Avg Engagement</div>
                        </div>
                    </div>
                    <div style="padding: 1rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.375rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">📊 Data Status</div>
                        <div style="font-size: 0.875rem; color: #9ca3af;">
                            Last updated: ${new Date(summary.last_updated || Date.now()).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
            
            element.innerHTML = html;
        }

        async function loadIntelligenceData() {
            try {
                console.log('Loading intelligence data...');
                const response = await fetch('/intelligence/analysis');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Intelligence data loaded:', data);
                    // Process and display intelligence data
                } else {
                    console.log('Intelligence endpoint not available, showing placeholder');
                }
                
                // Show placeholder content for now
                document.getElementById('competitorAnalysis').innerHTML = `
                    <div style="padding: 1rem;">
                        <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">Competitor Insights</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                                <strong>Supreme:</strong> High engagement on limited drops
                            </div>
                            <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                                <strong>Stussy:</strong> Strong community building content
                            </div>
                            <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                                <strong>KITH:</strong> Lifestyle integration strategy
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('marketInsights').innerHTML = `
                    <div style="padding: 1rem;">
                        <h4 style="color: var(--crooks-orange); margin-bottom: 1rem;">Market Trends</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                                📈 <strong>Streetwear Revival:</strong> +25% engagement
                            </div>
                            <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                                🎵 <strong>Music Collabs:</strong> High conversion rate
                            </div>
                            <div style="padding: 0.5rem; background-color: rgba(255, 107, 53, 0.1); border-radius: 0.25rem;">
                                👥 <strong>Community Focus:</strong> Building loyalty
                            </div>
                        </div>
                    </div>
                `;
                
                dataLoaded.intelligence = true;
                
            } catch (error) {
                console.error('Error loading intelligence data:', error);
            }
        }

        async function loadRevenueIntelligence() {
            try {
                console.log('Loading revenue intelligence...');
                // This will be populated when Shopify is connected
                dataLoaded.revenue = true;
            } catch (error) {
                console.error('Error loading revenue intelligence:', error);
            }
        }

        async function loadMediaLibrary() {
            try {
                console.log('Loading media library...');
                const response = await fetch('/media/stats');
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Media library loaded:', data);
                    
                    if (data.success) {
                        displayMediaLibrary(data.stats);
                    }
                } else {
                    console.log('Media endpoint not available, showing placeholder');
                }
                
                // Show placeholder for now
                document.getElementById('assetLibrary').innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📁</div>
                        <div>Upload media files to build your asset library</div>
                        <button onclick="document.getElementById('mediaUpload').click()" class="btn btn-primary" style="margin-top: 1rem;">
                            📤 Upload Media
                        </button>
                    </div>
                `;
                
                dataLoaded.media = true;
                
            } catch (error) {
                console.error('Error loading media library:', error);
            }
        }

        function displayMediaLibrary(stats) {
            const element = document.getElementById('assetLibrary');
            
            if (!stats || stats.total_files === 0) {
                element.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📁</div>
                        <div>No media files uploaded yet</div>
                        <button onclick="document.getElementById('mediaUpload').click()" class="btn btn-primary" style="margin-top: 1rem;">
                            📤 Upload Media
                        </button>
                    </div>
                `;
                return;
            }

            let html = '<div class="media-grid">';
            
            // Show stats summary
            html += `
                <div class="media-item" style="grid-column: 1 / -1;">
                    <div class="media-info">
                        <div class="media-title">📊 Library Statistics</div>
                        <div class="media-meta">
                            Total Files: ${stats.total_files} • 
                            Images: ${stats.images || 0} • 
                            Videos: ${stats.videos || 0} • 
                            Audio: ${stats.audio || 0}
                        </div>
                    </div>
                </div>
            `;
            
            html += '</div>';
            element.innerHTML = html;
        }

        // FIXED: Upload file function with proper error handling
        async function uploadFile(file, source = 'manual_upload') {
            try {
                console.log(`Uploading file: ${file.name}`);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('source', source);

                const response = await fetch('/ingest/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Upload result:', data);

                if (data.success) {
                    alert(`✅ File "${file.name}" uploaded successfully!\n\nProcessed ${data.records_processed} records\nColumns: ${data.columns?.join(', ') || 'N/A'}`);
                    
                    // Refresh overview data to show the new data
                    dataLoaded.overview = false;
                    if (currentTab === 'overview') {
                        loadOverviewData();
                    }
                } else {
                    throw new Error(data.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Error uploading file:', error);
                alert(`❌ Failed to upload "${file.name}": ${error.message}`);
            }
        }

        async function uploadMediaFile(file) {
            try {
                console.log(`Uploading media file: ${file.name}`);
                
                const formData = new FormData();
                formData.append('files', file);
                formData.append('category', 'user_upload');
                formData.append('description', `Uploaded via Command Center: ${file.name}`);

                const response = await fetch('/media/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Media upload result:', data);

                if (data.success) {
                    alert(`Media file "${file.name}" uploaded successfully!`);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Error uploading media file:', error);
                alert(`Failed to upload "${file.name}": ${error.message}`);
            }
        }

        async function processUploadedFile() {
            const fileInput = document.getElementById('fileUpload');
            const files = fileInput.files;

            if (!files || files.length === 0) {
                alert('Please select a file first');
                return;
            }

            for (const file of files) {
                await uploadFile(file, 'file_upload');
            }

            fileInput.value = '';
        }

        async function processJsonPaste() {
            const textarea = document.getElementById('jsonPasteArea');
            const jsonData = textarea.value.trim();

            if (!jsonData) {
                alert('Please paste JSON data first');
                return;
            }

            try {
                console.log('Processing pasted JSON data...');
                
                const parsedData = JSON.parse(jsonData);
                
                const response = await fetch('/ingest/paste', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parsedData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Paste processing result:', data);

                if (data.success) {
                    alert('JSON data processed successfully!');
                    textarea.value = '';
                    
                    // Refresh data if needed
                    dataLoaded.overview = false;
                    if (currentTab === 'overview') {
                        loadOverviewData();
                    }
                } else {
                    throw new Error(data.error || 'Processing failed');
                }

            } catch (error) {
                console.error('Error processing JSON paste:', error);
                alert(`Failed to process JSON data: ${error.message}`);
            }
        }

        async function checkShopifyStatus() {
            try {
                const response = await fetch('/shopify/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('shopifyStatus');
                const statusDot = statusElement.querySelector('.status-dot');
                const statusText = statusElement.querySelector('span');
                
                if (data.connected) {
                    statusDot.className = 'status-dot status-online';
                    statusText.textContent = 'Shopify: Connected';
                    document.getElementById('revenueImpact').textContent = 'Connected';
                } else {
                    statusDot.className = 'status-dot status-offline';
                    statusText.textContent = 'Shopify: Not Connected';
                    document.getElementById('revenueImpact').textContent = 'Not Connected';
                }
                
            } catch (error) {
                console.error('Error checking Shopify status:', error);
            }
        }

        async function testShopifyConnection() {
            const shopUrl = document.getElementById('shopUrl').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!shopUrl || !accessToken) {
                alert('Please enter both shop URL and access token');
                return;
            }

            try {
                console.log('Testing Shopify connection...');
                
                // Test the connection by attempting to fetch shop info
                const formData = new FormData();
                formData.append('shop_domain', shopUrl);
                formData.append('access_token', accessToken);

                const response = await fetch('/shopify/setup', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log('Connection test result:', data);

                if (data.success) {
                    alert('✅ Connection successful! You can now save the configuration.');
                } else {
                    alert('❌ Connection failed: ' + (data.detail || data.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Connection test error:', error);
                alert(`❌ Connection test failed: ${error.message}`);
            }
        }

        async function saveShopifyConfig() {
            const shopUrl = document.getElementById('shopUrl').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!shopUrl || !accessToken) {
                alert('Please enter both shop URL and access token');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('shop_domain', shopUrl);
                formData.append('access_token', accessToken);

                const response = await fetch('/shopify/setup', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    alert('Shopify configuration saved successfully!');
                    checkShopifyStatus();
                } else {
                    throw new Error(data.error || 'Setup failed');
                }

            } catch (error) {
                console.error('Error saving Shopify config:', error);
                alert(`Failed to save configuration: ${error.message}`);
            }
        }

        // FIXED: Sync Shopify data with proper request format
        async function syncShopifyData(type) {
            try {
                console.log(`Syncing Shopify ${type} data...`);
                
                // Prepare request body based on sync type
                let requestBody = {};
                
                if (type === 'sales' || type === 'traffic') {
                    // Sales and traffic endpoints expect AnalysisRequest format
                    requestBody = {
                        days_back: 30,
                        include_correlation: true
                    };
                }
                // Products endpoint doesn't need request body parameters

                const response = await fetch(`/shopify/sync/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`${type} sync result:`, data);

                if (data.success) {
                    alert(`✅ ${data.message}`);
                    
                    // Refresh revenue intelligence data
                    dataLoaded.revenue = false;
                    if (currentTab === 'revenue') {
                        loadRevenueIntelligence();
                    }
                } else {
                    throw new Error(data.error || `${type} sync failed`);
                }

            } catch (error) {
                console.error(`Error syncing ${type} data:`, error);
                alert(`❌ Failed to sync ${type} data: ${error.message}`);
            }
        }

        async function loadAssetLibrary() {
            try {
                console.log('Loading asset library...');
                const response = await fetch('/media/stats');
                
                if (response.ok) {
                    const data = await response.json();
                    displayMediaLibrary(data.stats);
                } else {
                    console.log('Media stats not available');
                }
            } catch (error) {
                console.error('Error loading asset library:', error);
            }
        }

        async function organizeAssets() {
            alert('Asset organization feature coming soon!');
        }

        function showErrorMessage(section, message) {
            console.error(`Error in ${section}:`, message);
            // Could implement a toast notification system here
        }
    </script>
</body>
</html>
