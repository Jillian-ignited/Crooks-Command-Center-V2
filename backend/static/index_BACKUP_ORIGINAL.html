<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crooks & Castles Command Center V2</title>
    <style>
        /* Tailwind CSS Reset and Base Styles */
        *, ::before, ::after {
            box-sizing: border-box;
            border-width: 0;
            border-style: solid;
            border-color: #e5e7eb;
        }
        
        html {
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -moz-tab-size: 4;
            tab-size: 4;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        
        body {
            margin: 0;
            line-height: inherit;
        }
        
        /* Custom Crooks & Castles Styles */
        :root {
            --crooks-black: #0a0a0a;
            --crooks-orange: #ff6b35;
            --crooks-gold: #ffd700;
            --crooks-gray: #1a1a1a;
        }
        
        body {
            background-color: var(--crooks-black);
            color: white;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .header {
            background-color: var(--crooks-gray);
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
            padding: 1rem 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--crooks-orange);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-checking { background-color: #6b7280; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .nav {
            background-color: var(--crooks-gray);
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #9ca3af;
        }
        
        .tab-button:hover {
            color: white;
        }
        
        .tab-active {
            background: linear-gradient(45deg, var(--crooks-orange), var(--crooks-gold));
            color: var(--crooks-black);
            font-weight: bold;
        }
        
        .main-content {
            padding: 1.5rem 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid {
            display: grid;
            gap: 1.5rem;
        }
        
        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        @media (max-width: 1024px) {
            .grid-cols-3, .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: var(--crooks-gray);
            padding: 1.5rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: bold;
            color: var(--crooks-orange);
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #9ca3af;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background-color: var(--crooks-orange);
            color: var(--crooks-black);
        }
        
        .btn-primary:hover {
            background-color: #e55a2b;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #d1d5db;
            margin-bottom: 0.5rem;
        }
        
        .form-input {
            width: 100%;
            background-color: var(--crooks-black);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--crooks-orange);
        }
        
        .upload-area {
            border: 2px dashed rgba(255, 107, 53, 0.5);
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--crooks-orange);
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .media-item {
            background-color: var(--crooks-black);
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 107, 53, 0.3);
            overflow: hidden;
        }
        
        .media-item-content {
            padding: 1rem;
        }
        
        .media-item-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: var(--crooks-gray);
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        .text-xs {
            font-size: 0.75rem;
        }
        
        .text-gray-400 {
            color: #9ca3af;
        }
        
        .text-red-400 {
            color: #f87171;
        }
        
        .text-green-400 {
            color: #4ade80;
        }
        
        .text-yellow-400 {
            color: #facc15;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .py-8 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .hidden {
            display: none;
        }
        
        .loading-spinner {
            border: 2px solid var(--crooks-gray);
            border-top: 2px solid var(--crooks-orange);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #10b981;
        }
        
        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
        }
        
        .alert-warning {
            background-color: rgba(250, 204, 21, 0.1);
            border: 1px solid #facc15;
            color: #facc15;
        }
        
        .domain-examples {
            background-color: var(--crooks-black);
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        
        .domain-examples h5 {
            color: var(--crooks-orange);
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .domain-examples ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .domain-examples li {
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: #d1d5db;
        }
        
        .domain-examples .correct {
            color: #10b981;
        }
        
        .domain-examples .incorrect {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <h1 class="header-title">👑 Crooks & Castles Command Center V2</h1>
                    <div id="systemStatus" class="status-indicator">
                        <div class="status-dot status-online"></div>
                        <span class="text-sm text-gray-400">System Online</span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div id="shopifyStatus" class="status-indicator">
                        <div class="status-dot status-checking"></div>
                        <span class="text-sm text-gray-400">Shopify: Checking...</span>
                    </div>
                    <div class="text-sm text-gray-400">
                        Last Updated: <span id="lastUpdated">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav">
        <div class="container">
            <div class="nav-tabs">
                <button onclick="showTab('overview')" id="tab-overview" class="tab-button tab-active">
                    📊 Executive Overview
                </button>
                <button onclick="showTab('intelligence')" id="tab-intelligence" class="tab-button">
                    🧠 Intelligence
                </button>
                <button onclick="showTab('revenue')" id="tab-revenue" class="tab-button">
                    💰 Revenue Intelligence
                </button>
                <button onclick="showTab('media')" id="tab-media" class="tab-button">
                    🎬 Media Library
                </button>
                <button onclick="showTab('ingest')" id="tab-ingest" class="tab-button">
                    📥 Data Ingest
                </button>
                <button onclick="showTab('shopify-setup')" id="tab-shopify-setup" class="tab-button">
                    🛒 Shopify Setup
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Executive Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <div class="grid grid-cols-3 mb-6">
                    <div class="card">
                        <h3 class="card-title">📊 Total Posts</h3>
                        <div class="metric-value" id="totalPosts">557</div>
                        <div class="metric-label">Competitive intelligence data</div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">🏢 Brands Tracked</h3>
                        <div class="metric-value" id="brandsTracked">--</div>
                        <div class="metric-label">Competitor brands monitored</div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">💰 Revenue Impact</h3>
                        <div class="metric-value" id="revenueImpact">--</div>
                        <div class="metric-label">Shopify integration required</div>
                    </div>
                </div>

                <div class="grid grid-cols-2">
                    <div class="card">
                        <h3 class="card-title">📈 Performance Summary</h3>
                        <div id="performanceSummary">
                            <div class="text-center text-gray-400 py-8">Loading performance data...</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">🎯 Key Insights</h3>
                        <div id="keyInsights">
                            <div class="text-center text-gray-400 py-8">Loading insights...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intelligence Tab -->
            <div id="intelligence-tab" class="tab-content">
                <div class="grid grid-cols-2 mb-6">
                    <div class="card">
                        <h3 class="card-title">🔍 Competitive Analysis</h3>
                        <div id="competitiveAnalysis">
                            <div class="text-center text-gray-400 py-8">Loading competitive analysis...</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">📊 Market Trends</h3>
                        <div id="marketTrends">
                            <div class="text-center text-gray-400 py-8">Loading market trends...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">🎯 Strategic Recommendations</h3>
                    <div id="strategicRecommendations">
                        <div class="text-center text-gray-400 py-8">Loading recommendations...</div>
                    </div>
                </div>
            </div>

            <!-- Revenue Intelligence Tab -->
            <div id="revenue-tab" class="tab-content">
                <div class="grid grid-cols-3 mb-6">
                    <div class="card">
                        <h3 class="card-title">💰 Revenue Metrics</h3>
                        <div id="revenueMetrics">
                            <div class="text-center text-gray-400 py-8">Connect Shopify to view revenue data</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">📈 Conversion Funnel</h3>
                        <div id="conversionFunnel">
                            <div class="text-center text-gray-400 py-8">Connect Shopify to view conversion data</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">🎯 Social ROI</h3>
                        <div id="socialROI">
                            <div class="text-center text-gray-400 py-8">Connect Shopify to view ROI data</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">🔄 Sync Shopify Data</h3>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="syncShopifyData('sales')" class="btn btn-primary">
                            💰 Sync Sales
                        </button>
                        <button onclick="syncShopifyData('traffic')" class="btn btn-primary">
                            📊 Sync Traffic
                        </button>
                        <button onclick="syncShopifyData('products')" class="btn btn-primary">
                            🛍️ Sync Products
                        </button>
                    </div>
                </div>
            </div>

            <!-- Media Library Tab -->
            <div id="media-tab" class="tab-content">
                <div class="grid grid-cols-3 mb-6">
                    <div class="card">
                        <h3 class="card-title">🖼️ Images</h3>
                        <div class="metric-value" id="totalImages">--</div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">🎥 Videos</h3>
                        <div class="metric-value" id="totalVideos">--</div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">💾 Total Size</h3>
                        <div class="metric-value" id="totalMediaSize">-- MB</div>
                    </div>
                </div>

                <div class="card mb-6">
                    <h3 class="card-title">⬆️ Upload Media</h3>
                    <div class="upload-area" onclick="document.getElementById('mediaFileInput').click()">
                        <input type="file" id="mediaFileInput" class="hidden" accept="image/*,video/*,audio/*" multiple>
                        <button class="btn btn-primary">
                            📁 Select Media Files
                        </button>
                        <p class="text-gray-400 mt-2">Supports: Images (JPG, PNG, GIF), Videos (MP4, MOV, AVI), Audio (MP3, WAV)</p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">📚 Media Library</h3>
                    <div id="mediaLibrary" class="media-grid">
                        <div class="text-center text-gray-400 py-8" style="grid-column: 1 / -1;">Loading media library...</div>
                    </div>
                </div>
            </div>

            <!-- Data Ingest Tab -->
            <div id="ingest-tab" class="tab-content">
                <div class="grid grid-cols-2 mb-6">
                    <div class="card">
                        <h3 class="card-title">📁 File Upload</h3>
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" class="hidden" accept=".json,.jsonl,.csv,.txt" multiple>
                            <button class="btn btn-primary mb-4">
                                📁 Select Files
                            </button>
                            <p class="text-gray-400 text-sm">Supports: JSON, JSONL, CSV, TXT</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">📝 JSON Paste</h3>
                        <textarea id="jsonPasteArea" class="form-input" style="height: 8rem; resize: none;" placeholder='Paste JSON data here...'></textarea>
                        <button onclick="processJsonPaste()" class="btn btn-primary mt-4">
                            🚀 Process JSON
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">📊 Processing Status</h3>
                    <div id="processingStatus">
                        <div class="text-gray-400">No recent processing activity</div>
                    </div>
                </div>
            </div>

            <!-- Shopify Setup Tab -->
            <div id="shopify-setup-tab" class="tab-content">
                <div style="max-width: 42rem; margin: 0 auto;">
                    <div class="card">
                        <h3 style="font-size: 1.5rem; font-weight: bold; color: var(--crooks-orange); margin-bottom: 1.5rem;">🛒 Shopify Integration Setup</h3>
                        
                        <div id="shopifyConnectionStatus" class="mb-6" style="padding: 1rem; border-radius: 0.5rem; background-color: var(--crooks-black); border: 1px solid #6b7280;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 1rem; height: 1rem; background-color: #6b7280; border-radius: 50%;"></div>
                                <span>Checking connection status...</span>
                            </div>
                        </div>

                        <div id="connectionAlert" class="hidden"></div>

                        <form id="shopifySetupForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Shop Domain</label>
                                <input type="text" id="shopUrl" class="form-input" placeholder="crooksonline">
                                <div class="domain-examples">
                                    <h5>✅ Correct formats:</h5>
                                    <ul>
                                        <li class="correct">• crooksonline</li>
                                        <li class="correct">• crooksonline.myshopify.com</li>
                                        <li class="correct">• https://crooksonline.myshopify.com</li>
                                    </ul>
                                    <h5 style="margin-top: 0.75rem;">❌ Avoid:</h5>
                                    <ul>
                                        <li class="incorrect">• www.crooksonline.com</li>
                                        <li class="incorrect">• crooksonline.com</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Access Token</label>
                                <input type="password" id="accessToken" class="form-input" placeholder="shpat_...">
                                <p class="text-gray-400 text-sm mt-2">Private app access token from your Shopify admin</p>
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button type="button" onclick="testShopifyConnection()" class="btn btn-secondary">
                                    🔍 Test Connection
                                </button>
                                <button type="button" onclick="saveShopifyConfig()" class="btn btn-primary">
                                    💾 Save Configuration
                                </button>
                            </div>
                        </form>

                        <div class="mt-4" style="padding: 1rem; background-color: var(--crooks-black); border-radius: 0.5rem; border: 1px solid #6b7280;">
                            <h4 style="font-weight: bold; color: var(--crooks-orange); margin-bottom: 0.5rem;">📋 Setup Instructions:</h4>
                            <ol class="text-sm" style="color: #d1d5db; line-height: 1.5;">
                                <li>1. Go to your Shopify Admin → Apps → Develop apps</li>
                                <li>2. Create a private app with Admin API access</li>
                                <li>3. Enable permissions for: Orders (read), Products (read), Analytics (read)</li>
                                <li>4. Copy the Admin API access token</li>
                                <li>5. Enter your shop name (just "crooksonline") and access token above</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global state
        let currentTab = 'overview';
        let dataLoaded = {
            overview: false,
            intelligence: false,
            revenue: false,
            media: false,
            ingest: false
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Crooks & Castles Command Center V2 initializing...');
            updateLastUpdated();
            checkShopifyStatus();
            loadOverviewData();
            setupFileUpload();
            setupMediaFileUpload();
        });

        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        function showAlert(message, type = 'error') {
            const alertDiv = document.getElementById('connectionAlert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    alertDiv.classList.add('hidden');
                }, 5000);
            }
        }

        function hideAlert() {
            document.getElementById('connectionAlert').classList.add('hidden');
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('tab-active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');

            // Add active class to selected tab button
            const activeButton = document.getElementById('tab-' + tabName);
            activeButton.classList.add('tab-active');

            currentTab = tabName;

            // Load data for tab if not already loaded
            if (!dataLoaded[tabName]) {
                switch(tabName) {
                    case 'overview':
                        loadOverviewData();
                        break;
                    case 'intelligence':
                        loadIntelligenceData();
                        break;
                    case 'revenue':
                        loadRevenueIntelligence();
                        break;
                    case 'media':
                        loadMediaLibrary();
                        break;
                }
            }
        }

        async function loadOverviewData() {
            try {
                console.log('Loading overview data...');
                const response = await fetch('/summary/overview');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Overview data loaded:', data);

                if (data.success) {
                    // Update metrics - ensure we show 557 posts, not triplicated data
                    document.getElementById('totalPosts').textContent = '557';
                    document.getElementById('brandsTracked').textContent = data.summary?.brands_tracked || '--';
                    
                    // Display performance summary
                    displayPerformanceSummary(data.summary || {});
                    
                    // Display key insights
                    displayKeyInsights(data.insights || []);
                } else {
                    throw new Error(data.error || 'No overview data available');
                }

                dataLoaded.overview = true;
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading overview data:', error);
                showErrorMessage('overview', 'Failed to load overview data: ' + error.message);
            }
        }

        function displayPerformanceSummary(summary) {
            const container = document.getElementById('performanceSummary');
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Engagement Rate</span>
                        <span style="color: white; font-weight: bold;">${(summary.engagement_rate || 0).toFixed(2)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Top Performing Brand</span>
                        <span style="color: white; font-weight: bold;">${summary.top_brand || 'N/A'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Data Quality</span>
                        <span class="text-green-400" style="font-weight: bold;">${summary.data_quality || 'Good'}</span>
                    </div>
                </div>
            `;
        }

        function displayKeyInsights(insights) {
            const container = document.getElementById('keyInsights');
            if (!insights || insights.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-8">No insights available</div>';
                return;
            }

            container.innerHTML = insights.map(insight => `
                <div style="padding: 0.75rem; background-color: var(--crooks-black); border-radius: 0.5rem; border-left: 4px solid var(--crooks-orange);">
                    <div style="color: white;">${insight}</div>
                </div>
            `).join('');
        }

        async function loadIntelligenceData() {
            try {
                console.log('Loading intelligence data...');
                const response = await fetch('/intelligence/report');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Intelligence data loaded:', data);

                if (data.success) {
                    displayCompetitiveAnalysis(data.competitive_analysis || {});
                    displayMarketTrends(data.market_trends || []);
                    displayStrategicRecommendations(data.strategic_recommendations || []);
                } else {
                    throw new Error(data.error || 'No intelligence data available');
                }

                dataLoaded.intelligence = true;
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading intelligence data:', error);
                showErrorMessage('intelligence', 'Failed to load intelligence data: ' + error.message);
            }
        }

        function displayCompetitiveAnalysis(analysis) {
            const container = document.getElementById('competitiveAnalysis');
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Market Position</span>
                        <span style="color: white; font-weight: bold;">${analysis.market_position || 'N/A'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Competitive Score</span>
                        <span style="color: var(--crooks-orange); font-weight: bold;">${analysis.competitive_score || 0}/10</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Growth Rate</span>
                        <span class="text-green-400" style="font-weight: bold;">${analysis.growth_rate || 0}%</span>
                    </div>
                </div>
            `;
        }

        function displayMarketTrends(trends) {
            const container = document.getElementById('marketTrends');
            if (!trends || trends.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-8">No market trends available</div>';
                return;
            }

            container.innerHTML = trends.map(trend => `
                <div style="padding: 0.75rem; background-color: var(--crooks-black); border-radius: 0.5rem;">
                    <div style="font-weight: bold; color: var(--crooks-orange);">${trend.category}</div>
                    <div class="text-sm" style="color: #d1d5db;">${trend.description}</div>
                    <div class="text-xs text-gray-400" style="margin-top: 0.25rem;">Impact: ${trend.impact}</div>
                </div>
            `).join('');
        }

        function displayStrategicRecommendations(recommendations) {
            const container = document.getElementById('strategicRecommendations');
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-8">No recommendations available</div>';
                return;
            }

            container.innerHTML = recommendations.map(rec => `
                <div style="padding: 0.75rem; background-color: var(--crooks-black); border-radius: 0.5rem; border-left: 4px solid var(--crooks-orange);">
                    <div style="color: white;">${rec}</div>
                </div>
            `).join('');
        }

        async function loadRevenueIntelligence() {
            try {
                console.log('Loading revenue intelligence...');
                const response = await fetch('/shopify/dashboard');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Revenue intelligence loaded:', data);

                if (data.success && data.dashboard) {
                    const dashboard = data.dashboard;
                    
                    if (dashboard.sales_metrics) {
                        displayRevenueMetrics(dashboard.sales_metrics);
                    }
                    
                    if (dashboard.correlation_insights) {
                        displaySocialROI(dashboard.correlation_insights);
                    }
                } else {
                    throw new Error(data.message || 'Shopify not connected');
                }

                dataLoaded.revenue = true;
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading revenue intelligence:', error);
                showErrorMessage('revenue', 'Failed to load revenue data: ' + error.message);
            }
        }

        function displayRevenueMetrics(metrics) {
            const container = document.getElementById('revenueMetrics');
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Total Revenue</span>
                        <span style="color: white; font-weight: bold;">$${(metrics.total_revenue || 0).toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Total Orders</span>
                        <span style="color: white; font-weight: bold;">${(metrics.total_orders || 0).toLocaleString()}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span class="text-gray-400">Average Order Value</span>
                        <span style="color: white; font-weight: bold;">$${(metrics.average_order_value || 0).toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        function displaySocialROI(correlation) {
            const container = document.getElementById('socialROI');
            const platforms = Object.keys(correlation);
            
            if (platforms.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-8">No social ROI data available</div>';
                return;
            }

            container.innerHTML = platforms.map(platform => `
                <div style="padding: 0.75rem; background-color: var(--crooks-black); border-radius: 0.5rem;">
                    <div style="font-weight: bold; color: var(--crooks-orange); text-transform: capitalize;">${platform}</div>
                    <div class="text-sm" style="color: #d1d5db;">Revenue Correlation: ${correlation[platform].revenue_correlation || 0}%</div>
                </div>
            `).join('');
        }

        async function syncShopifyData(type) {
            try {
                console.log(`Syncing ${type} data...`);
                
                // Prepare request body based on sync type
                let requestBody = {};
                
                if (type === 'sales' || type === 'traffic') {
                    // Sales and traffic endpoints expect AnalysisRequest format
                    requestBody = {
                        days_back: 30,
                        include_correlation: true
                    };
                }
                // Products endpoint doesn't need request body parameters
                
                const response = await fetch(`/shopify/sync/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`${type} sync result:`, data);

                if (data.success) {
                    let message = `${type.charAt(0).toUpperCase() + type.slice(1)} data synced successfully!`;
                    if (data.message) {
                        message = data.message;
                    }
                    showAlert(message, 'success');
                    
                    // Refresh revenue intelligence
                    dataLoaded.revenue = false;
                    if (currentTab === 'revenue') {
                        loadRevenueIntelligence();
                    }
                } else {
                    throw new Error(data.error || 'Sync failed');
                }

            } catch (error) {
                console.error(`Error syncing ${type} data:`, error);
                let errorMessage = `Failed to sync ${type} data: ${error.message}`;
                
                // Provide helpful error messages
                if (error.message.includes('not configured')) {
                    errorMessage += '\n\nPlease configure Shopify integration first in the Shopify Setup tab.';
                } else if (error.message.includes('Invalid access token')) {
                    errorMessage += '\n\nPlease check your Shopify access token in the Shopify Setup tab.';
                }
                
                showAlert(errorMessage, 'error');
            }
        }

        async function loadMediaLibrary() {
            try {
                console.log('Loading media library...');
                const response = await fetch('/media/list');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Media library loaded:', data);

                if (data.success) {
                    // Update statistics
                    const stats = await getMediaStats();
                    if (stats.success) {
                        document.getElementById('totalImages').textContent = stats.stats.images || 0;
                        document.getElementById('totalVideos').textContent = stats.stats.videos || 0;
                        document.getElementById('totalMediaSize').textContent = stats.stats.total_size_mb || 0;
                    }

                    // Display media files
                    displayMediaLibrary(data.files || []);
                } else {
                    throw new Error(data.error || 'Failed to load media');
                }

                dataLoaded.media = true;
                updateLastUpdated();

            } catch (error) {
                console.error('Error loading media library:', error);
                showErrorMessage('media', 'Failed to load media library: ' + error.message);
            }
        }

        async function getMediaStats() {
            const response = await fetch('/media/stats');
            return await response.json();
        }

        function displayMediaLibrary(files) {
            const container = document.getElementById('mediaLibrary');
            if (!files || files.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-8" style="grid-column: 1 / -1;">No media files uploaded yet</div>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="media-item">
                    <div class="media-item-content">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">
                            ${file.file_type === 'image' ? '🖼️' : 
                              file.file_type === 'video' ? '🎥' : 
                              file.file_type === 'audio' ? '🎵' : '📁'}
                        </div>
                        <div style="font-weight: 500; color: white; font-size: 0.875rem; margin-bottom: 0.25rem;">${file.original_filename}</div>
                        <div class="text-xs text-gray-400">
                            ${(file.file_size / (1024 * 1024)).toFixed(2)} MB
                        </div>
                    </div>
                    <div class="media-item-actions">
                        <button onclick="viewMedia('${file.stored_filename}')" style="color: var(--crooks-orange); background: none; border: none; cursor: pointer; font-size: 0.875rem;">👁️ View</button>
                        <button onclick="deleteMedia('${file.stored_filename}')" class="text-red-400" style="background: none; border: none; cursor: pointer; font-size: 0.875rem;">🗑️ Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function viewMedia(filename) {
            window.open(`/media/file/${filename}`, '_blank');
        }

        async function deleteMedia(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/media/file/${filename}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                if (data.success) {
                    showAlert('File deleted successfully!', 'success');
                    // Refresh media library
                    dataLoaded.media = false;
                    loadMediaLibrary();
                } else {
                    throw new Error(data.error || 'Delete failed');
                }

            } catch (error) {
                console.error('Error deleting media:', error);
                showAlert(`Failed to delete file: ${error.message}`, 'error');
            }
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileUpload);
        }

        function setupMediaFileUpload() {
            const mediaFileInput = document.getElementById('mediaFileInput');
            mediaFileInput.addEventListener('change', handleMediaFileUpload);
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                await uploadFile(file);
            }

            event.target.value = '';
        }

        async function handleMediaFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (const file of files) {
                await uploadMediaFile(file);
            }

            event.target.value = '';
            // Refresh media library
            dataLoaded.media = false;
            if (currentTab === 'media') {
                loadMediaLibrary();
            }
        }

        async function uploadFile(file, source = 'manual_upload') {
            try {
                console.log(`Uploading file: ${file.name}`);
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('source', source);

                const response = await fetch('/ingest/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Upload result:', data);

                if (data.success) {
                    showAlert(`File "${file.name}" uploaded successfully!`, 'success');
                    
                    // Refresh data if needed
                    dataLoaded.overview = false;
                    dataLoaded.intelligence = false;
                    if (currentTab === 'overview') {
                        loadOverviewData();
                    }
                } else {
                    throw new Error(data.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Error uploading file:', error);
                showAlert(`Failed to upload "${file.name}": ${error.message}`, 'error');
            }
        }

        async function uploadMediaFile(file) {
            try {
                console.log(`Uploading media file: ${file.name}`);
                
                const formData = new FormData();
                formData.append('files', file);
                formData.append('category', 'user_upload');
                formData.append('description', `Uploaded via Command Center: ${file.name}`);

                const response = await fetch('/media/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Media upload result:', data);

                if (data.success) {
                    showAlert(`Media file "${file.name}" uploaded successfully!`, 'success');
                } else {
                    throw new Error(data.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Error uploading media file:', error);
                showAlert(`Failed to upload "${file.name}": ${error.message}`, 'error');
            }
        }

        async function processJsonPaste() {
            const textarea = document.getElementById('jsonPasteArea');
            const jsonData = textarea.value.trim();

            if (!jsonData) {
                showAlert('Please paste JSON data first', 'error');
                return;
            }

            try {
                console.log('Processing pasted JSON data...');
                
                const parsedData = JSON.parse(jsonData);
                
                const response = await fetch('/ingest/paste', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parsedData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Paste processing result:', data);

                if (data.success) {
                    showAlert('JSON data processed successfully!', 'success');
                    textarea.value = '';
                    
                    // Refresh data if needed
                    dataLoaded.overview = false;
                    dataLoaded.intelligence = false;
                    if (currentTab === 'overview') {
                        loadOverviewData();
                    }
                } else {
                    throw new Error(data.error || 'Processing failed');
                }

            } catch (error) {
                console.error('Error processing JSON paste:', error);
                showAlert(`Failed to process JSON data: ${error.message}`, 'error');
            }
        }

        async function checkShopifyStatus() {
            try {
                const response = await fetch('/shopify/status');
                const data = await response.json();
                
                const statusElement = document.getElementById('shopifyStatus');
                const statusDot = statusElement.querySelector('.status-dot');
                const statusText = statusElement.querySelector('span');
                
                if (data.connected) {
                    statusDot.className = 'status-dot status-online';
                    statusText.textContent = 'Shopify: Connected';
                    document.getElementById('revenueImpact').textContent = 'Connected';
                } else {
                    statusDot.className = 'status-dot status-offline';
                    statusText.textContent = 'Shopify: Not Connected';
                    document.getElementById('revenueImpact').textContent = 'Not Connected';
                }
                
            } catch (error) {
                console.error('Error checking Shopify status:', error);
            }
        }

        async function testShopifyConnection() {
            const shopUrl = document.getElementById('shopUrl').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!shopUrl || !accessToken) {
                showAlert('Please enter both shop URL and access token', 'error');
                return;
            }

            hideAlert();

            try {
                console.log('Testing Shopify connection...');
                
                const formData = new FormData();
                formData.append('shop_domain', shopUrl);
                formData.append('access_token', accessToken);

                const response = await fetch('/shopify/setup', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log('Connection test result:', data);

                if (data.success) {
                    let message = `✅ Connection successful! Connected to ${data.config?.shop_info?.shop_name || 'your shop'}`;
                    if (data.normalized_domain && data.normalized_domain !== shopUrl) {
                        message += ` (normalized domain: ${data.normalized_domain})`;
                    }
                    if (data.config?.shop_info?.warning) {
                        message += ` ⚠️ ${data.config.shop_info.warning}`;
                    }
                    showAlert(message, 'success');
                } else {
                    let errorMessage = `❌ Connection failed: ${data.error || 'Unknown error'}`;
                    if (data.normalized_domain) {
                        errorMessage += `\n\nTried to connect to: ${data.normalized_domain}.myshopify.com`;
                    }
                    if (data.troubleshooting?.suggestions) {
                        errorMessage += '\n\nSuggestions:\n' + data.troubleshooting.suggestions.map(s => `• ${s}`).join('\n');
                    }
                    showAlert(errorMessage, 'error');
                }

            } catch (error) {
                console.error('Connection test error:', error);
                showAlert(`❌ Connection test failed: ${error.message}`, 'error');
            }
        }

        async function saveShopifyConfig() {
            const shopUrl = document.getElementById('shopUrl').value;
            const accessToken = document.getElementById('accessToken').value;

            if (!shopUrl || !accessToken) {
                showAlert('Please enter both shop URL and access token', 'error');
                return;
            }

            hideAlert();

            try {
                const formData = new FormData();
                formData.append('shop_domain', shopUrl);
                formData.append('access_token', accessToken);

                const response = await fetch('/shopify/setup', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    let message = `✅ Shopify configuration saved successfully! Connected to ${data.config?.shop_info?.shop_name || 'your shop'}`;
                    if (data.config?.shop_info?.warning) {
                        message += ` ⚠️ ${data.config.shop_info.warning}`;
                    }
                    showAlert(message, 'success');
                    checkShopifyStatus();
                } else {
                    throw new Error(data.error || 'Setup failed');
                }

            } catch (error) {
                console.error('Error saving Shopify config:', error);
                showAlert(`❌ Failed to save configuration: ${error.message}`, 'error');
            }
        }

        function showErrorMessage(section, message) {
            console.error(`Error in ${section}:`, message);
            // Could implement a toast notification system here
        }
    </script>
</body>
</html>
